import { analyzeConstitution } from '../utils/constitution.js';
import Syndrome from '../models/Syndrome.js';
import DiagnosisRecord from '../models/DiagnosisRecord.js';
import ConstitutionRecord from '../models/ConstitutionRecord.js';
import Acupuncture from '../models/Acupuncture.js';
import SymptomComparison from '../models/SymptomComparison.js';
import Knowledge from '../models/Knowledge.js';

class TcmService {
  constructor() {
    // 24èŠ‚æ°”æ•°æ®
    this.solarTerms = [
      { name: 'ç«‹æ˜¥', month: 2, day: 4, diet: 'å®œé£Ÿè¾›ç”˜å‘æ•£ä¹‹å“ï¼Œå¦‚é¦™èœã€éŸ­èœã€è™¾ä»ç­‰ï¼Œå¿Œé…¸æ”¶ã€‚', living: 'æ™šç¡æ—©èµ·ï¼ŒæŠ«å‘ç¼“è¡Œï¼Œèˆ’ç¼“å¿ƒæƒ…ã€‚' },
      { name: 'é›¨æ°´', month: 2, day: 19, diet: 'å®œå¥è„¾åˆ©æ¹¿ï¼Œå¤šé£Ÿå±±è¯ã€è–ç±³ã€å°ç±³ç²¥ã€‚', living: 'æ³¨æ„ä¿æš–ï¼Œé¢„é˜²â€œå€’æ˜¥å¯’â€ã€‚' },
      { name: 'æƒŠè›°', month: 3, day: 5, diet: 'å®œæ¸…æ·¡å…»è‚ºï¼Œå¤šåƒæ¢¨ã€æ‡æ·ã€é“¶è€³ã€‚', living: 'ä¿è¯ç¡çœ ï¼Œå¤šåšæˆ·å¤–è¿åŠ¨ã€‚' },
      { name: 'æ˜¥åˆ†', month: 3, day: 20, diet: 'é¥®é£Ÿå®œå¹³è¡¡ï¼Œå¿Œå¤§å¯’å¤§çƒ­ã€‚', living: 'æ³¨æ„å±…å®¤é€šé£ï¼Œé¢„é˜²è¿‡æ•ã€‚' },
      { name: 'æ¸…æ˜', month: 4, day: 4, diet: 'å®œæ¸…è¡¥ï¼Œå¤šåƒè èœã€è èœã€å±±è¯ã€‚', living: 'å¤šå‡ºå¤–è¸é’ï¼Œèˆ’å±•æƒ…å¿—ã€‚' },
      { name: 'è°·é›¨', month: 4, day: 20, diet: 'å®œå¥è„¾ç¥›æ¹¿ï¼Œå¤šå–èµ¤å°è±†æ±¤ã€å†¬ç“œæ±¤ã€‚', living: 'è°¨é˜²æ¹¿ç–¹ï¼Œæ—©èµ·æ—©ç¡ã€‚' },
      { name: 'ç«‹å¤', month: 5, day: 5, diet: 'å®œå…»å¿ƒï¼Œå¤šé£Ÿçº¢è‰²é£Ÿç‰©å¦‚ç•ªèŒ„ã€çº¢è±†ã€‚', living: 'å¢åŠ åˆä¼‘ï¼Œä¿æŒå¹³å’Œå¿ƒæ€ã€‚' },
      { name: 'å°æ»¡', month: 5, day: 21, diet: 'å®œæ¸…åˆ©æ¹¿çƒ­ï¼Œå¤šåƒè‹¦ç“œã€é»„ç“œã€ç»¿è±†ã€‚', living: 'æ³¨æ„çš®è‚¤æ¸…æ´ï¼Œé˜²æ­¢æ¹¿ç–¹ã€‚' },
      { name: 'èŠ’ç§', month: 6, day: 5, diet: 'å®œç¥›æš‘ç›Šæ°”ï¼Œå¤šå–é…¸æ¢…æ±¤ã€ç»¿è±†æ±¤ã€‚', living: 'æ³¨æ„é˜²æš‘ï¼Œå‹¤æ´—æ¾¡æ¢è¡£ã€‚' },
      { name: 'å¤è‡³', month: 6, day: 21, diet: 'å®œå¤šåƒè‹¦å‘³é£Ÿç‰©ï¼Œå¿Œç”Ÿå†·ã€‚', living: 'æ³¨æ„é˜²æ™’ï¼Œé¿å…å‰§çƒˆè¿åŠ¨ã€‚' },
      { name: 'å°æš‘', month: 7, day: 7, diet: 'å®œæ¸…æš‘ç”Ÿæ´¥ï¼Œå¤šåƒè¥¿ç“œã€è²å­ã€‚', living: 'å°‘åŠ¨å¤šé™ï¼Œé¢„é˜²ä¸­æš‘ã€‚' },
      { name: 'å¤§æš‘', month: 7, day: 22, diet: 'å®œè¡¥æ°”æ¸…æš‘ï¼Œå¤šé£ŸèŒ¯è‹“ã€èŠ¡å®ã€‚', living: 'æ³¨æ„å±…å®¤å‡‰çˆ½ï¼Œè°¨é˜²ç©ºè°ƒç—…ã€‚' },
      { name: 'ç«‹ç§‹', month: 8, day: 7, diet: 'å®œæ»‹é˜´æ¶¦è‚ºï¼Œå¤šåƒç™¾åˆã€é“¶è€³ã€‚', living: 'æ—©å§æ—©èµ·ï¼Œæ•›ç¥å…»æ°”ã€‚' },
      { name: 'å¤„æš‘', month: 8, day: 23, diet: 'å®œæ¶¦ç‡¥ç›Šæ°”ï¼Œå¤šåƒæ¢¨ã€èŠéº»ã€‚', living: 'é¢„é˜²ç§‹ä¹ï¼Œä¿è¯ç¡çœ ã€‚' },
      { name: 'ç™½éœ²', month: 9, day: 7, diet: 'å®œå…»è‚ºç”Ÿæ´¥ï¼Œå¤šåƒè¸è ã€ç”˜è”—ã€‚', living: 'æ³¨æ„è¶³éƒ¨ä¿æš–ï¼Œé˜²æ­¢æ„Ÿå†’ã€‚' },
      { name: 'ç§‹åˆ†', month: 9, day: 22, diet: 'å®œç”˜æ¶¦ç”Ÿæ´¥ï¼Œå¤šåƒæŸ¿å­ã€æŸ‘æ©˜ã€‚', living: 'é€‚é‡è¿åŠ¨ï¼Œä¿æŒå¿ƒæƒ…å¼€æœ—ã€‚' },
      { name: 'å¯’éœ²', month: 10, day: 8, diet: 'å®œæ»‹é˜´é˜²ç‡¥ï¼Œå¤šåƒèœ‚èœœã€ç³¯ç±³ã€‚', living: 'æ³¨æ„ä¿æš–ï¼Œå°¤å…¶æ˜¯è¶³éƒ¨ã€‚' },
      { name: 'éœœé™', month: 10, day: 23, diet: 'å®œå¹³è¡¥ï¼Œå¤šåƒæŸ¿å­ã€ç‰›è‚‰ã€èåœã€‚', living: 'æ—©ç¡æ—©èµ·ï¼ŒåŠ å¼ºé”»ç‚¼ã€‚' },
      { name: 'ç«‹å†¬', month: 11, day: 7, diet: 'å®œè¡¥è‚¾å¾¡å¯’ï¼Œå¤šåƒé»‘è±†ã€é»‘æœ¨è€³ã€‚', living: 'æ—©å§æ™šèµ·ï¼Œå¿…å¾…æ—¥å…‰ã€‚' },
      { name: 'å°é›ª', month: 11, day: 22, diet: 'å®œæ¸©è¡¥ï¼Œå¤šåƒç¾Šè‚‰ã€è…°æœã€å±±è¯ã€‚', living: 'æ³¨æ„å®¤å†…æ¹¿åº¦ï¼Œé˜²å¯’ä¿æš–ã€‚' },
      { name: 'å¤§é›ª', month: 12, day: 7, diet: 'å®œè¿›è¡¥ï¼Œå¤šåƒçº¢æ£ã€æ¡‚åœ†ã€‚', living: 'é¿å¯’å°±æ¸©ï¼Œä¿æŒå¿ƒæƒ…æ„‰å¿«ã€‚' },
      { name: 'å†¬è‡³', month: 12, day: 21, diet: 'å®œæ¸©é˜³ï¼Œå¤šåƒæ°´é¥ºã€ç¾Šè‚‰æ±¤ã€‚', living: 'æ—©ç¡æ™šèµ·ï¼Œé€‚åº¦é”»ç‚¼ã€‚' },
      { name: 'å°å¯’', month: 1, day: 5, diet: 'å®œè¡¥è‚¾å…»å¿ƒï¼Œå¤šåƒç³¯ç±³ã€æ¸æã€‚', living: 'åŠ å¼ºä¿æš–ï¼Œå¤šæ™’å¤ªé˜³ã€‚' },
      { name: 'å¤§å¯’', month: 1, day: 20, diet: 'å®œæ¸©è¡¥æ°”è¡€ï¼Œå¤šåƒå…«å®é¥­ã€é¸¡æ±¤ã€‚', living: 'ç¡å‰çƒ­æ°´æ³¡è„šï¼Œæ”¹å–„ç¡çœ ã€‚' }
    ];

    // AI æç¤ºè¯ä¸è¯æœ¯é…ç½®
    this.aiConfig = {
      // 3. AI æ·±åº¦å’¨è¯¢ï¼ˆèŠå¤©ï¼‰é…ç½®
      chatPersona: {
        basePrompt: 'ä½ æ˜¯ä¸€ä½èµ„æ·±ä¸­åŒ»ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯é€šè¿‡å¯¹è¯å¼•å¯¼æ‚£è€…æè¿°ç—‡çŠ¶ï¼Œæœ€ç»ˆç»™å‡ºè¾¨è¯åˆ†æã€‚',
        guidelines: [
          'é¦–å…ˆæ¸©å’Œåœ°é—®å€™æ‚£è€…ï¼Œå¹¶è¯¢é—®å…¶æœ€ä¸»è¦çš„ä¸é€‚ã€‚',
          'æ ¹æ®æ‚£è€…çš„å›ç­”ï¼Œé€æ­¥å¼•å¯¼å…¶å›ç­”â€œåé—®æ­Œâ€ä¸­çš„ç›¸å…³å†…å®¹ï¼ˆå¯’çƒ­ã€æ±—ã€å¤´èº«ã€ä¾¿ã€é¥®é£Ÿã€èƒ¸è…¹ã€è€³ç›®ã€ç¡çœ ã€å¦‡å¥³ã€å°å„¿ï¼‰ã€‚',
          'æ¯æ¬¡æé—®ä¸è¦è¶…è¿‡ä¸¤ä¸ªé—®é¢˜ï¼Œä¿æŒå¯¹è¯è‡ªç„¶ã€‚',
          'å½“ä¿¡æ¯æ”¶é›†è¶³å¤Ÿæ—¶ï¼ˆè‡³å°‘æ¶µç›–5ä¸ªä»¥ä¸Šå…³é”®ç»´åº¦ï¼‰ï¼Œæä¾›ä¸€ä»½ç®€è¦çš„è¾¨è¯æ€»ç»“ï¼Œå¹¶å»ºè®®å…¶ä½¿ç”¨â€œæ™ºèƒ½é—®è¯Šâ€åŠŸèƒ½è·å–è¯¦ç»†æŠ¥å‘Šã€‚',
          'å§‹ç»ˆåŒ…å«å…è´£å£°æ˜ï¼šæœ¬å¯¹è¯ä»…ä¾›ç§‘æ™®å‚è€ƒï¼Œä¸æ›¿ä»£ä¸´åºŠè¯Šæ–­ã€‚'
        ],
        firstMessage: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„ AI ä¸­åŒ»å¥åº·é¡¾é—®ã€‚è¯·é—®æ‚¨æœ€è¿‘èº«ä½“æœ‰å“ªäº›ä¸é€‚ï¼Ÿæ‚¨å¯ä»¥æè¿°ç—‡çŠ¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å‘é€èˆŒè±¡æè¿°ï¼ˆå¦‚â€œèˆŒçº¢è‹”é»„â€ï¼‰è¿›è¡Œä¸­åŒ»è¾¨è¯ã€‚'
      },
      // 4. èˆŒè¯Šè„‰è¯Šä¸“å®¶äººæ ¼é…ç½®
      tonguePulsePersona: {
        basePrompt: 'ä½ æ˜¯ä¸€ä½ä¸“æ³¨èˆŒè¯Šã€è„‰è¯Šçš„ä¸­åŒ»ä¸“å®¶ï¼Œç²¾é€šèˆŒè±¡ã€è„‰è±¡ä¸è„è…‘æ°”è¡€æ´¥æ¶²çš„ç›¸å…³æ€§ã€‚',
        analysisSteps: [
          '1. åˆ†æèˆŒè±¡ï¼šèˆŒè´¨ï¼ˆæ·¡/çº¢/ç»›/ç´«/èƒ–/ç˜¦/è£‚çº¹/é½¿ç—•ç­‰ï¼‰ã€èˆŒè‹”ï¼ˆè–„ç™½/é»„è…»/ç™½è…»/å°‘è‹”/æ— è‹”/å‰¥è‹”ç­‰ï¼‰ã€èˆŒä½“åŠ¨æ€ï¼ˆèƒ–å¤§/ç˜¦è–„/æ­ªæ–œç­‰ï¼‰ï¼Œæ¨ç†å¯¹åº”è„è…‘è™šå®å¯’çƒ­ã€‚',
          '2. ç»“åˆç—‡çŠ¶å’Œè„‰è±¡ï¼šç»¼åˆåˆ†æå¯’çƒ­è™šå®ã€æ°”è¡€è¿è¡Œæƒ…å†µã€‚',
          '3. ç»™å‡ºè¾¨è¯ï¼šç»™å‡ºæœ€ç»ˆçš„ä¸­åŒ»è¾¨è¯ç»“è®ºã€‚'
        ],
        outputStructure: `## èˆŒè±¡åˆ†æ
[è¯¦ç»†æè¿° + å¯¹åº”ç—…æœºæ¨ç†]

## ç»¼åˆè¾¨è¯
[å…«çº² + è„è…‘/å«æ°”è¥è¡€/å…­ç»ç­‰]

## å¯èƒ½è¯å‹åŠä¾æ®
1. xxxè¯ï¼ˆæ¦‚ç‡æœ€é«˜ï¼‰ï¼šç†ç”±...
2. ...

## è°ƒç†å»ºè®®
[æ–¹è¯/ç©´ä½/é£Ÿç–—]

é‡è¦ï¼šä»»ä½•åˆ†æä»…ä¾›å‚è€ƒï¼Œå¿…é¡»é¢è¯Šç»“åˆåˆ‡è„‰æ‰èƒ½ç¡®è¯Šã€‚å¼ºçƒˆå»ºè®®ç”¨æˆ·å°½å¿«æ‰¾ä¸­åŒ»å¸ˆå½“é¢è¯Šæ²»ã€‚`
      },
      // 1. èµ„æ·±ä¸­åŒ»ä¸´åºŠåŒ»ç”Ÿäººæ ¼é…ç½®
      doctorPersona: {
        basePrompt: 'ä½ æ˜¯ä¸€ä½ç²¾é€šé’ˆç¸ã€æ¨æ‹¿ã€é£Ÿç–—çš„ä¸­åŒ»å¸ˆã€‚ä¸¥æ ¼éµå¾ªâ€œè¾¨è¯æ–½æ²»â€åŸåˆ™ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·ç—‡çŠ¶/è¯å‹ï¼Œæä¾›ä¸“ä¸šçš„è¾¨è¯åˆ†æã€ç©´ä½æ¨èåŠé£Ÿç–—å»ºè®®ã€‚',
        privacyDisclaimer: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„ä¸­åŒ»å¥åº·åŠ©æ‰‹ã€‚ä»¥ä¸‹åˆ†æä¿¡æ¯ä»…ç”¨äºå¥åº·ç§‘æ™®ä¸è¾…åŠ©å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸´åºŠåŒ»ç”Ÿçš„é¢å¯¹é¢è¯Šæ–­ã€‚',
        analysisFlow: 'è¯·ç»“åˆç”¨æˆ·æä¾›çš„å¯’çƒ­ã€æ±—ã€å¤´èº«ã€å››è‚¢ã€å£æ¸´ã€äºŒä¾¿ã€é¥®é£Ÿã€ç¡çœ åŠèˆŒè„‰ç­‰ä¿¡æ¯ï¼Œè¿›è¡Œæ·±åº¦è¾¨è¯æ¨ç†ã€‚',
        outputStructure: `è¾“å‡ºæ ¼å¼ä¸¥æ ¼ä½¿ç”¨ Markdownï¼š
## åˆæ­¥è¾¨è¯åˆ†æ
[è¯¦ç»†æ¨ç†è¿‡ç¨‹ï¼ŒåŒ…å«å…«çº²è¾¨è¯ã€å…­ç»/ä¸‰ç„¦/å«æ°”è¥è¡€è¾¨è¯é€»è¾‘]

## è¯å‹ç»“è®º
[æœ€å¯èƒ½è¯å‹]ï¼ˆå¯èƒ½æ€§æ’åºï¼Œåˆ—å‡ºå‰2-3ä¸ªï¼‰

## æ¨èç©´ä½
1. ç©´ä½åï¼ˆç»ç»œï¼‰
   - å®šä½ï¼š
   - åŠŸæ•ˆï¼š
   - æ“ä½œæ–¹æ³•ï¼šï¼ˆæŒ‰æ‰/è‰¾ç¸/åˆ®ç—§ç­‰ï¼‰
   - ç¦å¿Œï¼š

## é£Ÿç–—å»ºè®®
æ–¹ä¸€ï¼šxxx
- ææ–™ï¼š
- åšæ³•ï¼š
- åŠŸæ•ˆï¼š
- æ³¨æ„ï¼š

## å»ºè®®æ–¹æ¡ˆ
- æ–¹è¯æ¨èï¼š[æ¨èç»å…¸æ–¹å‰‚æˆ–ä¸­æˆè¯ï¼Œæ³¨æ˜å‡ºå¤„]
- è°ƒæŠ¤æ³¨æ„ï¼š[ç”Ÿæ´»æ–¹å¼å»ºè®®]
- å°±åŒ»è­¦ç¤ºï¼š[çº¢æ——ç—‡çŠ¶è­¦ç¤º]`
      },
      // 2. ä½“è´¨åˆ†æé…ç½®
      constitutionPersona: {
        basePrompt: 'ä½ æ˜¯ä¸€åä¸­åŒ»ä½“è´¨åˆ†æè¾…åŠ© AIï¼Œè¯·åŸºäºä¸­åŒ»ä½“è´¨ç†è®ºï¼Œå¯¹ç”¨æˆ·æä¾›çš„å¤šç»´ç—‡çŠ¶ä¸ç”Ÿæ´»çŠ¶æ€ä¿¡æ¯è¿›è¡Œç³»ç»Ÿåˆ†æï¼Œåˆ¤æ–­å…¶ä½“è´¨å€¾å‘ã€‚åˆ¤æ–­è¿‡ç¨‹éœ€éµå¾ªâ€œå¤šç—‡çŠ¶ç»¼åˆã€ä¸»æ¬¡åˆ†æ˜ã€åŠ¨æ€å˜åŒ–â€åŸåˆ™ã€‚ç»“è®ºéœ€ä½¿ç”¨â€œå¯èƒ½â€â€œå€¾å‘â€ç­‰æè¿°æ–¹å¼ï¼Œé¿å…ç¡®å®šæ€§è¯Šæ–­è¯­è¨€ã€‚',
        dimensionsPrompt: 'åˆ†æç»´åº¦åŒ…æ‹¬ï¼š1.å¯¹å¯’çƒ­çš„æ„Ÿå—ï¼›2.ç²¾ç¥ä¸ä½“åŠ›çŠ¶æ€ï¼›3.å‡ºæ±—æƒ…å†µï¼›4.æ¶ˆåŒ–ä¸ä»£è°¢è¡¨ç°ï¼›5.åˆ†æ³Œç‰©ç‰¹å¾ï¼›6.å­£èŠ‚é€‚åº”èƒ½åŠ›ï¼›7.ç”Ÿæ´»æ–¹å¼å½±å“ã€‚',
        outputStructure: 'è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡º JSONï¼š{ "primary_constitution": "ä¸»å¯¼ä½“è´¨å€¾å‘", "secondary_constitution": "å…¼è§ä½“è´¨å€¾å‘", "evidence_summary": "è¡¨ç°ä¸º...", "lifestyle_factors": "è¿‘æœŸç”Ÿæ´»å½±å“å› ç´ ", "adjustment_direction": "æ ¸å¿ƒè°ƒå…»å»ºè®®", "disclaimer": "å…è´£å£°æ˜" }'
      },
      goldSentences: [
        { 
          text: 'â€œæ˜¥ä¸‰æœˆï¼Œæ­¤è°“å‘é™ˆï¼Œå¤©åœ°ä¿±ç”Ÿï¼Œä¸‡ç‰©ä»¥è£ã€‚â€', 
          translation: 'æ˜¥å­£çš„ä¸‰ä¸ªæœˆï¼Œæ˜¯ä¸‡ç‰©æ¨é™ˆå‡ºæ–°çš„å­£èŠ‚ã€‚å¤©åœ°è‡ªç„¶éƒ½å¯Œæœ‰ç”Ÿæœºï¼Œä¸‡ç‰©æ¬£æ¬£å‘è£ã€‚' 
        },
        { 
          text: 'â€œé¥®é£Ÿæœ‰èŠ‚ï¼Œèµ·å±…æœ‰å¸¸ï¼Œä¸å¦„ä½œåŠ³ï¼Œæ•…èƒ½å½¢ä¸ç¥ä¿±ã€‚â€', 
          translation: 'é¥®é£Ÿæœ‰èŠ‚åˆ¶ï¼Œä½œæ¯æœ‰è§„å¾‹ï¼Œä¸è¿‡åº¦åŠ³ç´¯ï¼Œè¿™æ ·å°±èƒ½ä½¿èº«ä½“å’Œç²¾ç¥éƒ½ä¿æŒå¥åº·ã€‚' 
        },
        { 
          text: 'â€œæ¬æ·¡è™šæ— ï¼ŒçœŸæ°”ä»ä¹‹ï¼Œç²¾ç¥å†…å®ˆï¼Œç—…å®‰ä»æ¥ï¼Ÿâ€', 
          translation: 'å¿ƒæƒ…å®‰é™æ¸…é—²ï¼Œä¸å­˜æ‚å¿µï¼ŒçœŸæ°”å°±èƒ½é¡ºä»è¿è¡Œï¼Œç²¾ç¥å®ˆæŒäºå†…ï¼Œç–¾ç—…æ€ä¹ˆä¼šå‘ç”Ÿå‘¢ï¼Ÿ' 
        },
        { 
          text: 'â€œæ³•äºé˜´é˜³ï¼Œå’Œäºæœ¯æ•°ï¼Œé£Ÿé¥®æœ‰èŠ‚ï¼Œèµ·å±…æœ‰å¸¸ã€‚â€', 
          translation: 'æ•ˆæ³•è‡ªç„¶ç•Œçš„é˜´é˜³å˜åŒ–è§„å¾‹ï¼Œè°ƒå’Œå„ç§å…»ç”Ÿæ–¹æ³•ï¼Œé¥®é£ŸèŠ‚åˆ¶ï¼Œèµ·å±…è§„å¾‹ã€‚' 
        },
        { 
          text: 'â€œæ˜¥å¤å…»é˜³ï¼Œç§‹å†¬å…»é˜´ï¼Œä»¥ä»å…¶æ ¹ã€‚â€', 
          translation: 'æ˜¥å¤ä¸¤å­£åº”å½“ä¿å…»é˜³æ°”ï¼Œç§‹å†¬ä¸¤å­£åº”å½“ä¿å…»é˜´ç²¾ï¼Œä»¥é¡ºåº”è‡ªç„¶ç•Œçš„ç”Ÿé•¿æ”¶è—è§„å¾‹ã€‚' 
        }
      ],
      nightReminders: [
        'å¤œæ·±äº†ï¼Œæ—©ç‚¹ä¼‘æ¯å§ï¼Œå­æ—¶å‰å…¥çœ æœ€å…»è‚è¡€ã€‚',
        'ç¯ç«é˜‘çŠå¤„ï¼Œèº«ä½“ä¹Ÿéœ€è¦å®‰é™ã€‚æ™šå®‰ï¼Œæ„¿å¥½æ¢¦ã€‚',
        'é™åå¸¸æ€ï¼Œæ—©ç¡å…»ç¥ã€‚æ·±å¤œçš„å®é™æ˜¯ç»™èº«ä½“æœ€å¥½çš„ç¤¼ç‰©ã€‚'
      ],
      // æ–°å¢ï¼šç—‡çŠ¶å¯¹ç…§è‡ªæŸ¥é…ç½®
      symptomComparisonConfig: {
        basePrompt: 'ä½ æ˜¯ä¸€åä¸­åŒ»å¥åº·ç§‘æ™®è¾…åŠ© AIï¼Œè¯·åŸºäºä¸­åŒ»è¾¨è¯æ€è·¯ï¼Œå¯¹å•ä¸€ç—‡çŠ¶è¿›è¡Œâ€œå¯¹ç…§å¼åˆ†æâ€ï¼Œç”¨äºå¸®åŠ©ç”¨æˆ·ç†è§£ä¸åŒä½“è´¨æˆ–è¯å‹åœ¨åŒä¸€ç—‡çŠ¶ä¸‹çš„å¯èƒ½å·®å¼‚ã€‚',
        disclaimer: 'æœ¬åŠŸèƒ½ä»…ç”¨äºå¥åº·ç§‘æ™®ä¸è‡ªæˆ‘ç†è§£ï¼Œä¸æ„æˆåŒ»ç–—è¯Šæ–­æˆ–æ²»ç–—å»ºè®®ã€‚æ‰€æœ‰åˆ†æç»“æœéœ€ä»¥â€œå¯èƒ½â€â€œå¸¸è§è¡¨ç°ä¸ºâ€â€œé€šå¸¸è¿˜ä¼šä¼´éšâ€ç­‰è¡¨è¿°æ–¹å¼å‘ˆç°ï¼Œé¿å…ç¡®å®šæ€§åˆ¤æ–­ã€‚',
        outputStructure: 'è¯·å°†ç—‡çŠ¶å¯¹ç…§åˆ†æç»“æœæ•´ç†ä¸ºç»“æ„åŒ–å±•ç¤ºå½¢å¼ï¼Œæ¯ä¸ªå¯¹ç…§é¡¹åŒ…æ‹¬ï¼štitle(æƒ…å†µåç§°), feature(è¯¥ç—‡çŠ¶çš„å…¸å‹è¡¨ç°), accompanying_signs(å¸¸ä¼´éšè¡¨ç°), self_observation_tip(è‡ªæˆ‘è§‚å¯Ÿæç¤º)ã€‚'
      }
    };

    // æ–°å¢ï¼šç—‡çŠ¶å¯¹ç…§æ•°æ®
    this.symptomComparisonData = {
      'å’½ç—›': [
        {
          title: 'åé£çƒ­',
          feature: 'å’½å–‰çº¢è‚¿ç–¼ç—›æ˜æ˜¾ï¼Œåå’½æ—¶åŠ é‡',
          accompanying_signs: 'å‘çƒ­ã€å£æ¸´ã€ç—°é»„',
          self_observation_tip: 'è§‚å¯Ÿå’½å–‰æ˜¯å¦çº¢è‚¿ï¼Œæ˜¯å¦æ¸´æœ›å–å†·æ°´',
          diet_advice: 'å®œé£Ÿæ¸…å‡‰ç”Ÿæ´¥ä¹‹å“ï¼Œå¦‚æ¢¨ã€è¸è ã€ç½—æ±‰æœã€‚å¿Œè¾›è¾£çƒŸé…’ã€‚',
          living_advice: 'ä¿æŒå®¤å†…ç©ºæ°”æ¹¿æ¶¦ï¼Œå¤šé¥®æ¸©å¼€æ°´ï¼Œå‡å°‘ç”¨å—“ã€‚',
          treatment_suggestion: 'è¾›å‡‰æ¸…è§£ã€‚å¯å‚è€ƒä½¿ç”¨æ¿è“æ ¹é¢—ç²’ã€ç‰›é»„è§£æ¯’ç‰‡ç­‰ã€‚'
        },
        {
          title: 'åé˜´è™š',
          feature: 'å’½å¹²éšç—›ï¼Œå¤œé—´æˆ–å¤šè¨€ååŠ é‡',
          accompanying_signs: 'æ‰‹è¶³å¿ƒçƒ­ã€ç›—æ±—ã€å¹²å’³å°‘ç—°',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦ä¼´æœ‰å£å¹²èˆŒç‡¥ï¼Œä¸”å–æ°´éš¾è§£',
          diet_advice: 'å®œé£Ÿæ»‹é˜´æ¶¦ç‡¥ä¹‹å“ï¼Œå¦‚ç™¾åˆã€é“¶è€³ã€èœ‚èœœã€‚',
          living_advice: 'é¿å…ç†¬å¤œï¼Œä¿æŒå……è¶³ç¡çœ ï¼Œå¿Œé£Ÿè¾›è¾£å¹²ç‡¥é£Ÿç‰©ã€‚',
          treatment_suggestion: 'æ»‹é˜´é™ç«ã€‚å¯å‚è€ƒä½¿ç”¨çŸ¥æŸåœ°é»„ä¸¸ã€ç„éº¦ç”˜æ¡”é¢—ç²’ã€‚'
        }
      ],
      'å¤´ç—›': [
        {
          title: 'åé£å¯’',
          feature: 'å¤´éƒ¨å†·ç—›ï¼Œå¾—çƒ­ç—›å‡ï¼Œé‡é£åŠ é‡',
          accompanying_signs: 'æ€•å†·ã€æ— æ±—ã€é¢ˆé¡¹å¼ºç—›',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦ä¼´éšæ˜æ˜¾çš„æ€•é£æ€•å†·æ„Ÿ',
          diet_advice: 'å®œé£Ÿè¾›æ¸©æ•£å¯’ä¹‹å“ï¼Œå¦‚ç”Ÿå§œã€è‘±ç™½ã€‚',
          living_advice: 'æ³¨æ„å¤´éƒ¨ä¿æš–ï¼Œé¿å…ç›´æ¥å¹é£ã€‚',
          treatment_suggestion: 'ç–é£æ•£å¯’ã€‚å¯å‚è€ƒä½¿ç”¨å·èŠèŒ¶è°ƒä¸¸ã€‚'
        },
        {
          title: 'åè‚ç«',
          feature: 'å¤´ç—›èƒ€è£‚ï¼Œç”šåˆ™ç›®èµ¤å£è‹¦',
          accompanying_signs: 'æ€¥èºæ˜“æ€’ã€é¢çº¢ã€å°¿é»„',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦åœ¨æƒ…ç»ªæ¿€åŠ¨ååŠ é‡',
          diet_advice: 'å®œé£Ÿæ¸…è‚æ³»ç«ä¹‹å“ï¼Œå¦‚èŠ¹èœã€è‹¦ç“œã€èŠèŠ±ã€‚',
          living_advice: 'ä¿æŒå¿ƒæƒ…èˆ’ç•…ï¼Œé¿å…ç†¬å¤œã€‚',
          treatment_suggestion: 'æ¸…è‚æ³»ç«ã€‚å¯å‚è€ƒä½¿ç”¨é¾™èƒ†æ³»è‚ä¸¸ã€‚'
        }
      ],
      'å’³å—½': [
        {
          title: 'åé£ç‡¥',
          feature: 'å¹²å’³æ— ç—°ï¼Œæˆ–ç—°å°‘è€Œé»ï¼Œä¸æ˜“å’³å‡º',
          accompanying_signs: 'å’½å¹²ã€é¼»ç‡¥ã€èˆŒçº¢å°‘è‹”',
          self_observation_tip: 'è§‚å¯Ÿæ˜¯å¦ä¸ºå¹²å’³ï¼Œä¸”åœ¨å¹²ç‡¥ç¯å¢ƒä¸‹åŠ é‡',
          diet_advice: 'å®œé£Ÿæ¸…æ¶¦ç”Ÿæ´¥ä¹‹å“ï¼Œå¦‚é›ªæ¢¨ã€é“¶è€³ã€ç™¾åˆã€‚',
          living_advice: 'ä¿æŒå®¤å†…æ¹¿åº¦ï¼Œå¤šé¥®æ°´ï¼Œé¿å…è¾›è¾£åˆºæ¿€ã€‚',
          treatment_suggestion: 'ç–é£æ¶¦ç‡¥ã€‚å¯å‚è€ƒä½¿ç”¨å…»é˜´æ¸…è‚ºä¸¸ã€‚'
        },
        {
          title: 'åç—°æ¹¿',
          feature: 'å’³å—½ç—°å¤šï¼Œè‰²ç™½å‘ˆæ³¡æ²«çŠ¶æˆ–é»è…»',
          accompanying_signs: 'èƒ¸é—·ã€è„˜ç—ã€èˆŒè‹”ç™½è…»',
          self_observation_tip: 'æ³¨æ„ç—°é‡æ˜¯å¦è¾ƒå¤šï¼Œä¸”åœ¨æ—©æ™¨èµ·åºŠæ—¶è¾ƒé‡',
          diet_advice: 'å®œé£Ÿå¥è„¾åŒ–ç—°ä¹‹å“ï¼Œå¦‚é™ˆçš®ã€èŒ¯è‹“ã€è–ç±³ã€‚',
          living_advice: 'æ³¨æ„é˜²å¯’ä¿æš–ï¼Œé€‚å½“è¿åŠ¨ï¼Œå¿Œé£Ÿç”Ÿå†·æ²¹è…»ã€‚',
          treatment_suggestion: 'ç‡¥æ¹¿åŒ–ç—°ã€‚å¯å‚è€ƒä½¿ç”¨äºŒé™ˆä¸¸ã€‚'
        }
      ],
      'è…¹èƒ€': [
        {
          title: 'åé£Ÿç§¯',
          feature: 'è…¹éƒ¨èƒ€æ»¡ï¼Œå—³è…åé…¸ï¼ŒåŒé£Ÿ',
          accompanying_signs: 'å£è‡­ã€å¤§ä¾¿è‡­ç§½ã€èˆŒè‹”åšè…»',
          self_observation_tip: 'è§‚å¯Ÿæ˜¯å¦åœ¨é¥±é¤ååŠ é‡ï¼Œä¼´æœ‰é…¸è…å‘³å—³æ°”',
          diet_advice: 'å®œé£Ÿæ¶ˆé£Ÿå¯¼æ»ä¹‹å“ï¼Œå¦‚å±±æ¥‚ã€èåœã€éº¦èŠ½ã€‚',
          living_advice: 'é¥®é£Ÿæœ‰èŠ‚ï¼Œé¿å…æš´é¥®æš´é£Ÿï¼Œé¤åé€‚åº¦æ•£æ­¥ã€‚',
          treatment_suggestion: 'æ¶ˆé£Ÿå¯¼æ»ã€‚å¯å‚è€ƒä½¿ç”¨ä¿å’Œä¸¸ã€‚'
        },
        {
          title: 'åè„¾è™š',
          feature: 'è…¹èƒ€æ—¶ä½œæ—¶æ­¢ï¼Œé£ŸååŠ é‡ï¼ŒæŒ‰ä¹‹è¾ƒè½¯',
          accompanying_signs: 'ç¥ç–²ä¹åŠ›ã€çº³å‘†ã€ä¾¿æº',
          self_observation_tip: 'æ³¨æ„è…¹èƒ€æ˜¯å¦åœ¨åŠ³ç´¯æˆ–é¥­åæ˜æ˜¾ï¼ŒæŒ‰å‹è…¹éƒ¨æ˜¯å¦æ„Ÿåˆ°èˆ’æœ',
          diet_advice: 'å®œé£Ÿå¥è„¾ç›Šæ°”ä¹‹å“ï¼Œå¦‚å±±è¯ã€å…šå‚ã€æ‰è±†ã€‚',
          living_advice: 'æ³¨æ„è…¹éƒ¨ä¿æš–ï¼ŒåŠ³é€¸ç»“åˆï¼Œå¿Œé£Ÿç”Ÿå†·ã€‚',
          treatment_suggestion: 'å¥è„¾ç†æ°”ã€‚å¯å‚è€ƒä½¿ç”¨é¦™ç ‚å…­å›å­ä¸¸ã€‚'
        }
      ],
      'å¤±çœ ': [
        {
          title: 'åå¿ƒç«',
          feature: 'å…¥ç¡å›°éš¾ï¼Œå¿ƒçƒ¦æ„ä¹±ï¼Œå¤šæ¢¦',
          accompanying_signs: 'å£èˆŒç”Ÿç–®ã€å°¿èµ¤ã€èˆŒå°–çº¢',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦ä¼´æœ‰æ˜æ˜¾çš„ç„¦è™‘ä¸å®‰æ„Ÿå’Œå£èˆŒæºƒç–¡',
          diet_advice: 'å®œé£Ÿæ¸…å¿ƒå®‰ç¥ä¹‹å“ï¼Œå¦‚è²å­å¿ƒã€ç™¾åˆã€ç«¹å¶ã€‚',
          living_advice: 'ç¡å‰é¿å…è¿‡åº¦å…´å¥‹ï¼Œä¿æŒå§å®¤å®‰é™å‡‰çˆ½ã€‚',
          treatment_suggestion: 'æ¸…å¿ƒå®‰ç¥ã€‚å¯å‚è€ƒä½¿ç”¨å¤©ç‹è¡¥å¿ƒä¸¹ã€‚'
        },
        {
          title: 'åæ°”è¡€è™š',
          feature: 'å¤šæ¢¦æ˜“é†’ï¼Œç¡è€Œä¸å®ï¼Œç¥ç–²å¥å¿˜',
          accompanying_signs: 'å¿ƒæ‚¸ã€é¢è‰²è‹ç™½ã€èˆŒæ·¡è‹”è–„',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦ä¼´æœ‰å¿ƒæ…Œã€å¤´æ™•ä»¥åŠç–²åŠ³æ„Ÿ',
          diet_advice: 'å®œé£Ÿè¡¥ç›Šå¿ƒè„¾ä¹‹å“ï¼Œå¦‚æ¡‚åœ†ã€çº¢æ£ã€å°ç±³ã€‚',
          living_advice: 'ç¡å‰å¯ç”¨æ¸©æ°´æ³¡è„šï¼Œè§„å¾‹ä½œæ¯ï¼Œé¿å…æ€è™‘è¿‡åº¦ã€‚',
          treatment_suggestion: 'å…»è¡€å®‰ç¥ã€‚å¯å‚è€ƒä½¿ç”¨å½’è„¾ä¸¸ã€‚'
        }
      ],
      'ä¾¿ç§˜': [
        {
          title: 'åçƒ­ç»“',
          feature: 'å¤§ä¾¿å¹²ç»“ï¼Œæ’ä¾¿å›°éš¾ï¼Œæ•°æ—¥ä¸€è¡Œ',
          accompanying_signs: 'å£æ¸´ã€é¢èµ¤ã€è…¹ç—›æ‹’æŒ‰ã€èˆŒçº¢è‹”é»„',
          self_observation_tip: 'è§‚å¯Ÿå¤§ä¾¿æ˜¯å¦åšç¡¬å¦‚ç¾ŠçŸ¢ï¼Œæ˜¯å¦ä¼´æœ‰è…¹éƒ¨ç¼çƒ­æ„Ÿ',
          diet_advice: 'å®œé£Ÿæ¸…çƒ­æ¶¦è‚ ä¹‹å“ï¼Œå¦‚ç«é¾™æœã€é¦™è•‰ã€èœ‚èœœã€‚',
          living_advice: 'å¢åŠ è†³é£Ÿçº¤ç»´æ‘„å…¥ï¼Œå¤šé¥®æ°´ï¼Œå…»æˆå®šæ—¶æ’ä¾¿ä¹ æƒ¯ã€‚',
          treatment_suggestion: 'æ³»çƒ­é€šä¾¿ã€‚å¯å‚è€ƒä½¿ç”¨éº»ä»æ¶¦è‚ ä¸¸ã€‚'
        },
        {
          title: 'åæ°”è™š',
          feature: 'å¤§ä¾¿å¹¶ä¸å¹²ç¡¬ï¼Œä½†æ’ä¾¿æ— åŠ›ï¼ŒæŒ£åˆ™æ±—å‡º',
          accompanying_signs: 'ç¥ç–²æ°”çŸ­ã€é¢è‰²ã¿ ç™½ã€èˆŒæ·¡è‹”è–„',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦è¡¨ç°ä¸ºâ€œæƒ³æ’å´æ’ä¸å‡ºâ€ï¼Œæ’ä¾¿åæ„Ÿåˆ°æåº¦ç–²ä¹',
          diet_advice: 'å®œé£Ÿç›Šæ°”æ¶¦è‚ ä¹‹å“ï¼Œå¦‚é»‘èŠéº»ã€æ ¸æ¡ƒã€å±±è¯ã€‚',
          living_advice: 'é€‚åº¦è¿›è¡Œæè‚›è¿åŠ¨ï¼ŒåŠ å¼ºä½“è´¨ï¼Œå¿Œè¿‡åº¦åŠ³ç´¯ã€‚',
          treatment_suggestion: 'ç›Šæ°”æ¶¦è‚ ã€‚å¯å‚è€ƒä½¿ç”¨é»„èŠªæ±¤æˆ–è¡¥ä¸­ç›Šæ°”ä¸¸ã€‚'
        }
      ],
      'æ„Ÿå†’': [
        {
          title: 'é£å¯’æ„Ÿå†’',
          feature: 'æ¶å¯’é‡ï¼Œå‘çƒ­è½»ï¼Œæ— æ±—ï¼Œè‚¢ä½“é…¸ç—›',
          accompanying_signs: 'é¼»å¡æµæ¸…æ¶•ã€å–‰ç—’å’³å—½ã€ç—°ç¨€ç™½',
          self_observation_tip: 'è§‚å¯Ÿæ˜¯å¦éå¸¸æ€•é£æ€•å†·ï¼Œæµé¼»æ¶•æ˜¯å¦ä¸ºæ¸…æ°´çŠ¶',
          diet_advice: 'å®œé£Ÿè¾›æ¸©å‘æ•£ä¹‹å“ï¼Œå¦‚ç”Ÿå§œã€è‘±ç™½ã€çº¢ç³–æ°´ã€‚',
          living_advice: 'å¤šå–æ¸©æ°´ï¼Œæ³¨æ„ä¿æš–ï¼Œå¾®å¾®å‡ºæ±—ä¸ºä½³ã€‚',
          treatment_suggestion: 'è¾›æ¸©è§£è¡¨ã€‚å¯å‚è€ƒä½¿ç”¨è†é˜²è´¥æ¯’æ•£ã€æ„Ÿå†’æ¸…çƒ­é¢—ç²’ã€‚'
        },
        {
          title: 'é£çƒ­æ„Ÿå†’',
          feature: 'å‘çƒ­é‡ï¼Œå¾®æ¶é£å¯’ï¼Œæœ‰æ±—ï¼Œå’½å–‰çº¢è‚¿',
          accompanying_signs: 'é¼»å¡æµé»„æµŠæ¶•ã€å£æ¸´ã€å’³å—½ç—°ç²˜é»„',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦æœ‰æ˜æ˜¾çš„å’½å–‰ç–¼ç—›ï¼Œé¼»æ¶•æ˜¯å¦å˜é»„å˜ç¨ ',
          diet_advice: 'å®œé£Ÿè¾›å‡‰æ¸…è§£ä¹‹å“ï¼Œå¦‚è–„è·ã€èŠèŠ±ã€é‡‘é“¶èŠ±ã€‚',
          living_advice: 'å¤šé¥®æ°´ï¼Œä¿æŒå®¤å†…é€šé£ï¼Œé¿å…è¾›è¾£æ²¹è…»ã€‚',
          treatment_suggestion: 'è¾›å‡‰è§£è¡¨ã€‚å¯å‚è€ƒä½¿ç”¨é“¶ç¿˜è§£æ¯’ç‰‡ã€æ¡‘èŠé¥®ã€‚'
        }
      ],
      'èƒƒç—›': [
        {
          title: 'è‚æ°”çŠ¯èƒƒ',
          feature: 'èƒƒè„˜èƒ€æ»¡ï¼Œæ”»æ’‘ä½œç—›ï¼Œç—›è¿ä¸¤èƒ',
          accompanying_signs: 'å—³æ°”é¢‘ç¹ã€æƒ…ç»ªæ³¢åŠ¨å¤§ã€èˆŒè‹”è–„ç™½',
          self_observation_tip: 'æ³¨æ„èƒƒç—›æ˜¯å¦åœ¨ç”Ÿæ°”æˆ–ç²¾ç¥ç´§å¼ ååŠ é‡',
          diet_advice: 'å®œé£Ÿç–è‚ç†æ°”ä¹‹å“ï¼Œå¦‚ä½›æ‰‹ã€ç«ç‘°èŠ±ã€æ©˜çš®ã€‚',
          living_advice: 'ä¿æŒå¿ƒæƒ…èˆ’ç•…ï¼Œé¿å…æƒ…ç»ªæ¿€åŠ¨ï¼Œå¿Œç”Ÿå†·é£Ÿç‰©ã€‚',
          treatment_suggestion: 'ç–è‚è§£éƒï¼Œç†æ°”æ­¢ç—›ã€‚å¯å‚è€ƒä½¿ç”¨æŸ´èƒ¡ç–è‚ä¸¸ã€‚'
        },
        {
          title: 'è„¾èƒƒè™šå¼±',
          feature: 'èƒƒè„˜éšç—›ï¼Œå–œæš–å–œæŒ‰ï¼Œç©ºè…¹ç—›ç”š',
          accompanying_signs: 'ç¥ç–²ä¹åŠ›ã€çº³åè„˜èƒ€ã€å¤§ä¾¿æºè–„',
          self_observation_tip: 'è§‚å¯ŸæŒ‰å‹èƒƒéƒ¨æ˜¯å¦æ„Ÿåˆ°èˆ’æœï¼Œè¿›é£Ÿçƒ­é£Ÿåç–¼ç—›æ˜¯å¦å‡è½»',
          diet_advice: 'å®œé£Ÿå¥è„¾å’Œèƒƒä¹‹å“ï¼Œå¦‚å±±è¯ã€å…šå‚ã€å°ç±³ç²¥ã€‚',
          living_advice: 'æ³¨æ„èƒƒéƒ¨ä¿æš–ï¼Œé¥®é£Ÿæœ‰èŠ‚ï¼Œç»†åš¼æ…¢å’½ã€‚',
          treatment_suggestion: 'å¥è„¾ç›Šæ°”ï¼Œæ¸©ä¸­å’Œèƒƒã€‚å¯å‚è€ƒä½¿ç”¨é¦™ç ‚å…­å›å­ä¸¸ã€‚'
        }
      ],
      'ç—›ç»': [
        {
          title: 'å¯’æ¹¿å‡æ»',
          feature: 'ç»å‰æˆ–ç»æœŸå°è…¹å†·ç—›ï¼Œå¾—çƒ­ç—›å‡',
          accompanying_signs: 'ç»è‰²ç´«é»¯æœ‰å—ã€ç•å¯’ä¾¿æºã€èˆŒè‹”ç™½è…»',
          self_observation_tip: 'è§‚å¯Ÿå°è…¹æ˜¯å¦æœ‰å†·æ„Ÿï¼Œçƒ­æ•·åç–¼ç—›æ˜¯å¦æ˜æ˜¾å¥½è½¬',
          diet_advice: 'å®œé£Ÿæ¸©ç»æ•£å¯’ä¹‹å“ï¼Œå¦‚ç”Ÿå§œã€çº¢ç³–ã€è‰¾å¶ç²¥ã€‚',
          living_advice: 'ç»æœŸä¸¥ç¦ç”Ÿå†·ï¼Œæ³¨æ„è…°è…¹ä¿æš–ã€‚',
          treatment_suggestion: 'æ¸©ç»æ•£å¯’ï¼ŒåŒ–ç˜€æ­¢ç—›ã€‚å¯å‚è€ƒä½¿ç”¨å°‘è…¹é€ç˜€ä¸¸ã€‚'
        },
        {
          title: 'æ°”æ»è¡€ç˜€',
          feature: 'ç»å‰æˆ–ç»æœŸå°è…¹èƒ€ç—›ï¼ŒæŒ‰ä¹‹ç—›ç”š',
          accompanying_signs: 'ä¹³æˆ¿èƒ€ç—›ã€è¡Œç»ä¸ç•…ã€æœ‰è¡€å—',
          self_observation_tip: 'æ³¨æ„ç»å‰æ˜¯å¦ä¼´æœ‰æ˜æ˜¾çš„ä¹³æˆ¿èƒ€ç—›å’Œå¿ƒæƒ…çƒ¦èº',
          diet_advice: 'å®œé£Ÿæ´»è¡€ç†æ°”ä¹‹å“ï¼Œå¦‚å±±æ¥‚ã€çº¢èŠ±ã€ç›Šæ¯è‰ã€‚',
          living_advice: 'ä¿æŒå¿ƒæƒ…èˆ’ç•…ï¼Œé€‚åº¦æ´»åŠ¨ï¼Œå¿Œé£Ÿè¾›è¾£ã€‚',
          treatment_suggestion: 'ç†æ°”æ´»è¡€ï¼ŒåŒ–ç˜€æ­¢ç—›ã€‚å¯å‚è€ƒä½¿ç”¨ç›Šæ¯è‰é¢—ç²’ã€‚'
        }
      ],
      'ç—¤ç–®': [
        {
          title: 'è‚ºç»é£çƒ­',
          feature: 'çš®æŸä»¥çº¢è‰²ä¸˜ç–¹ä¸ºä¸»ï¼Œä¼´æœ‰ç—’ç—›',
          accompanying_signs: 'å£å¹²ã€èˆŒçº¢ã€è„‰æµ®æ•°',
          self_observation_tip: 'è§‚å¯Ÿç²‰åˆºæ˜¯å¦ä»¥é¼»å‘¨åŠé¢å¤´ä¸ºä¸»ï¼Œè‰²çº¢ä¸”ä¼´æœ‰å£é¼»å¹²ç‡¥',
          diet_advice: 'å®œé£Ÿæ¸…è‚ºæ³»ç«ä¹‹å“ï¼Œå¦‚æ‡æ·ã€é›ªæ¢¨ã€ç»¿è±†ã€‚',
          living_advice: 'å‹¤æ´—è„¸ï¼Œä¿æŒé¢éƒ¨æ¸…æ´ï¼Œå¿Œé£Ÿæ²¹è…»è¾›è¾£ã€‚',
          treatment_suggestion: 'ç–é£æ¸…è‚ºã€‚å¯å‚è€ƒä½¿ç”¨æ‡æ·æ¸…è‚ºé¥®ã€‚'
        },
        {
          title: 'èƒƒè‚ æ¹¿çƒ­',
          feature: 'çš®æŸä»¥çº¢è‚¿ã€è„“ç–±ä¸ºä¸»ï¼Œä¼´æœ‰ç»“èŠ‚',
          accompanying_signs: 'å£è‡­ã€ä¾¿ç§˜ã€èˆŒçº¢è‹”é»„è…»',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦ä¼´æœ‰æ˜æ˜¾çš„èƒƒè‚ ä¸é€‚ï¼Œå¦‚å£è‹¦å£è‡­ã€æ’ä¾¿ä¸ç•…',
          diet_advice: 'å®œé£Ÿæ¸…çƒ­åˆ©æ¹¿ä¹‹å“ï¼Œå¦‚è–ç±³ã€å†¬ç“œã€è‹¦ç“œã€‚',
          living_advice: 'ä¿æŒè§„å¾‹æ’ä¾¿ï¼Œä¿è¯å……è¶³ç¡çœ ï¼Œå‡å°‘ç”œé£Ÿã€‚',
          treatment_suggestion: 'æ¸…çƒ­åˆ©æ¹¿ã€‚å¯å‚è€ƒä½¿ç”¨æ¸…èƒƒé»„è¿ä¸¸ã€‚'
        }
      ],
      'æ³„æ³»': [
        {
          title: 'æ¹¿çƒ­ä¸‹æ³¨',
          feature: 'è…¹ç—›å³æ³»ï¼Œæ³»ä¸‹æ€¥è¿«ï¼Œç²ªè‰²é»„è¤ï¼Œæ°”å‘³è‡­ç§½',
          accompanying_signs: 'è‚›é—¨ç¼çƒ­ã€çƒ¦çƒ­å£æ¸´ã€å°¿çŸ­èµ¤',
          self_observation_tip: 'è§‚å¯Ÿæ’ä¾¿æ˜¯å¦å…·æœ‰â€œæ€¥ã€è‡­ã€çƒ­â€çš„ç‰¹ç‚¹',
          diet_advice: 'å®œé£Ÿæ¸…çƒ­åˆ©æ¹¿ä¹‹å“ï¼Œå¦‚é©¬é½¿è‹‹ã€ç»¿è±†ç²¥ã€è–ç±³æ°´ã€‚',
          living_advice: 'æ³¨æ„é¥®é£Ÿå«ç”Ÿï¼Œè…¹éƒ¨ä¿æš–ï¼Œå¿Œé£Ÿè¾›è¾£æ²¹è…»ã€‚',
          treatment_suggestion: 'æ¸…çƒ­åˆ©æ¹¿ï¼Œæ­¢æ³»ã€‚å¯å‚è€ƒä½¿ç”¨è‘›æ ¹èŠ©è¿æ±¤ã€‚'
        },
        {
          title: 'è„¾èƒƒè™šå¼±',
          feature: 'å¤§ä¾¿ç¨€æºï¼Œè‰²æ·¡æ— è‡­ï¼Œé£Ÿåæ˜“æ³»',
          accompanying_signs: 'ç¥ç–²è‚¢å€¦ã€é¢è‰²èé»„ã€èˆŒæ·¡è‹”ç™½',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦è¡¨ç°ä¸ºé•¿æœŸæ…¢æ€§è…¹æ³»ï¼Œä¸”åœ¨è¿›é£Ÿæ²¹è…»ååŠ é‡',
          diet_advice: 'å®œé£Ÿå¥è„¾ç›Šæ°”ä¹‹å“ï¼Œå¦‚å±±è¯ã€è²å­ã€èŠ¡å®ã€‚',
          living_advice: 'æ³¨æ„è…¹éƒ¨ä¿æš–ï¼Œç»†åš¼æ…¢å’½ï¼Œå¿Œé£Ÿç”Ÿå†·ã€‚',
          treatment_suggestion: 'å¥è„¾ç›Šæ°”ï¼ŒåŠ©è¿æ­¢æ³»ã€‚å¯å‚è€ƒä½¿ç”¨å‚è‹“ç™½æœ¯æ•£ã€‚'
        }
      ],
      'çœ©æ™•': [
        {
          title: 'ç—°æµŠä¸­é˜»',
          feature: 'çœ©æ™•å¤´é‡å¦‚è’™ï¼Œèƒ¸é—·æ¶å¿ƒ',
          accompanying_signs: 'é£Ÿå°‘å¤šå¯ã€èˆŒè‹”ç™½è…»ã€è„‰æ¿¡æ»‘',
          self_observation_tip: 'è§‚å¯Ÿæ˜¯å¦æ„Ÿåˆ°å¤´éƒ¨æ²‰é‡ï¼Œä»¿ä½›è¢«æ¹¿æ¯›å·¾åŒ…è£¹',
          diet_advice: 'å®œé£Ÿå¥è„¾åŒ–ç—°ä¹‹å“ï¼Œå¦‚é™ˆçš®ã€èŒ¯è‹“ã€å†¬ç“œã€‚',
          living_advice: 'é¥®é£Ÿå®œæ¸…æ·¡ï¼Œå¿Œè‚¥ç”˜åšå‘³ï¼Œä¿æŒå……è¶³ç¡çœ ã€‚',
          treatment_suggestion: 'ç‡¥æ¹¿ç¥›ç—°ï¼Œå¥è„¾å’Œèƒƒã€‚å¯å‚è€ƒä½¿ç”¨åŠå¤ç™½æœ¯å¤©éº»æ±¤ã€‚'
        },
        {
          title: 'è‚é˜³ä¸Šäº¢',
          feature: 'çœ©æ™•è€³é¸£ï¼Œå¤´ç›®èƒ€ç—›ï¼Œçƒ¦èºæ˜“æ€’',
          accompanying_signs: 'é¢è‰²æ½®çº¢ã€å¤±çœ å¤šæ¢¦ã€èˆŒçº¢å°‘è‹”',
          self_observation_tip: 'æ³¨æ„çœ©æ™•æ˜¯å¦åœ¨æƒ…ç»ªæ¿€åŠ¨æˆ–åŠ³ç´¯åæ˜æ˜¾åŠ é‡',
          diet_advice: 'å®œé£Ÿå¹³è‚æ½œé˜³ä¹‹å“ï¼Œå¦‚èŠ¹èœã€èŠèŠ±ã€æ¡‘å¶ã€‚',
          living_advice: 'ä¿æŒå¿ƒæƒ…å¹³å’Œï¼Œé¿å…ç†¬å¤œï¼Œå¿ŒçƒŸé…’è¾›è¾£ã€‚',
          treatment_suggestion: 'å¹³è‚æ½œé˜³ï¼Œæ¸…çƒ­æ¯é£ã€‚å¯å‚è€ƒä½¿ç”¨å¤©éº»é’©è—¤é¢—ç²’ã€‚'
        }
      ],
      'è…¹ç—›': [
        {
          title: 'è„¾èƒƒè™šå¯’',
          feature: 'è…¹ç—›ç»µç»µï¼Œæ—¶ä½œæ—¶æ­¢ï¼Œå–œæ¸©å–œæŒ‰',
          accompanying_signs: 'å½¢å¯’è‚¢å†·ã€å¤§ä¾¿ç¨€è–„ã€èˆŒæ·¡è‹”ç™½',
          self_observation_tip: 'è§‚å¯Ÿè…¹éƒ¨åœ¨å—å‡‰æˆ–é¥¥é¥¿æ—¶æ˜¯å¦ç–¼ç—›åŠ é‡ï¼Œçƒ­æ•·æ˜¯å¦ç¼“è§£',
          diet_advice: 'å®œé£Ÿæ¸©ä¸­å¥è„¾ä¹‹å“ï¼Œå¦‚ç”Ÿå§œã€å¤§æ£ã€ç¾Šè‚‰ã€‚',
          living_advice: 'æ³¨æ„è…¹éƒ¨ä¿æš–ï¼Œé¿å…åŠ³ç´¯ï¼Œå¿Œé£Ÿç”Ÿå†·ã€‚',
          treatment_suggestion: 'æ¸©ä¸­å¥è„¾ï¼Œå’Œé‡Œç¼“æ€¥ã€‚å¯å‚è€ƒä½¿ç”¨å°å»ºä¸­æ±¤ã€‚'
        },
        {
          title: 'é¥®é£Ÿåœæ»',
          feature: 'è…¹ç—›æ‹’æŒ‰ï¼Œå—³è…åé…¸ï¼ŒåŒé£Ÿ',
          accompanying_signs: 'å£è‡­ã€å¤§ä¾¿è‡­ç§½ã€èˆŒè‹”åšè…»',
          self_observation_tip: 'æ³¨æ„æ˜¯å¦åœ¨é¥±é¤åçªå‘è…¹ç—›ï¼Œä¸”æ’ä¾¿åè…¹ç—›æœ‰æ‰€å‡è½»',
          diet_advice: 'å®œé£Ÿæ¶ˆé£Ÿå¯¼æ»ä¹‹å“ï¼Œå¦‚å±±æ¥‚ã€éº¦èŠ½ã€èåœã€‚',
          living_advice: 'é¥®é£Ÿæœ‰èŠ‚ï¼Œé¿å…æš´é¥®æš´é£Ÿï¼Œé¥­åæ•£æ­¥ã€‚',
          treatment_suggestion: 'æ¶ˆé£Ÿå¯¼æ»ï¼Œå’Œèƒƒæ­¢ç—›ã€‚å¯å‚è€ƒä½¿ç”¨ä¿å’Œä¸¸ã€‚'
        }
      ]
    };

    // æ–°å¢ï¼šä¸­åŒ»åŸºç¡€çŸ¥è¯†æ•°æ®
    this.knowledgeData = [
      {
        id: '1',
        title: 'åŸºç¡€ç†è®º (ç†)',
        icon: 'â˜¯ï¸',
        sections: [
          {
            title: 'é˜´é˜³äº”è¡Œ',
            content: 'é˜´é˜³æ˜¯å®‡å®™ä¸‡ç‰©å¯¹ç«‹ç»Ÿä¸€çš„æ€»è§„å¾‹ï¼Œç”¨äºé˜é‡Šäººä½“ç»„ç»‡ç»“æ„ã€ç”Ÿç†åŠŸèƒ½åŠç—…ç†å˜åŒ–ã€‚äº”è¡Œï¼ˆæœ¨ã€ç«ã€åœŸã€é‡‘ã€æ°´ï¼‰åˆ™é€šè¿‡ç”Ÿå…‹ä¹˜ä¾®å…³ç³»ï¼Œæ­ç¤ºè„è…‘é—´çš„åŠ¨æ€å¹³è¡¡ã€‚'
          },
          {
            title: 'è„è…‘è—è±¡',
            content: 'â€œè—â€æŒ‡å†…åœ¨è„è…‘ï¼Œâ€œè±¡â€æŒ‡å¤–åœ¨å¾è±¡ã€‚äº”è„ï¼ˆå¿ƒè‚è„¾è‚ºè‚¾ï¼‰ä¸»è—ç²¾æ°”ï¼Œå…­è…‘ï¼ˆèƒ†èƒƒå¤§è‚ å°è‚ è†€èƒ±ä¸‰ç„¦ï¼‰ä¸»ä¼ åŒ–ç‰©ï¼Œé€šè¿‡â€œè±¡â€æ¥å¯ŸçŸ¥å†…éƒ¨è„è…‘çš„ç›ˆè™šã€‚'
          },
          {
            title: 'æ°”è¡€æ´¥æ¶²',
            content: 'æ°”æ˜¯æ¨åŠ¨ç”Ÿå‘½æ´»åŠ¨çš„åŠ¨åŠ›ï¼Œè¡€æ˜¯è¥å…»å…¨èº«çš„ç‰©è´¨åŸºç¡€ï¼Œæ´¥æ¶²æ˜¯ä½“å†…æ­£å¸¸æ°´æ¶²çš„æ€»ç§°ã€‚ä¸‰è€…äº’æ ¹äº’ç”¨ï¼Œå…±åŒç»´æŒäººä½“çš„ç”Ÿé•¿å‘è‚²ä¸æ–°é™ˆä»£è°¢ã€‚'
          },
          {
            title: 'ç»ç»œå­¦è¯´',
            content: 'ç»ç»œæ˜¯äººä½“è¿è¡Œæ°”è¡€ã€è”ç»œè„è…‘ã€æ²Ÿé€šå†…å¤–ã€è´¯ç©¿ä¸Šä¸‹çš„é€šè·¯ã€‚é€šè¿‡ç»ç»œç³»ç»Ÿçš„è°ƒèŠ‚ï¼Œäººä½“å„éƒ¨åŠŸèƒ½å¾—ä»¥ä¿æŒç›¸å¯¹å¹³è¡¡ä¸åè°ƒã€‚'
          }
        ]
      },
      {
        id: '2',
        title: 'ç—…å› ç—…æœº (å˜)',
        icon: 'ğŸŒªï¸',
        sections: [
          {
            title: 'å…­æ·«ä¸ƒæƒ…',
            content: 'å¤–æ„Ÿâ€œé£å¯’æš‘æ¹¿ç‡¥ç«â€å…­æ·«é‚ªæ°”ï¼Œå†…ä¼¤â€œå–œæ€’å¿§æ€æ‚²ææƒŠâ€ä¸ƒæƒ…è¿‡æ¿€ã€‚å†…å¤–å› äº¤ç»‡ï¼Œæ‰“ç ´äººä½“é˜´é˜³å¹³è¡¡å¯¼è‡´å‘ç—…ã€‚'
          },
          {
            title: 'é¥®é£ŸåŠ³é€¸',
            content: 'é¥®é£Ÿä¸èŠ‚ã€ä¸æ´æˆ–åå—œä¼¤åŠè„¾èƒƒï¼›è¿‡åŠ³åˆ™æŸæ°”è€—ç²¾ï¼Œè¿‡é€¸åˆ™æ°”æ»è¡€ç˜€ã€‚ç”Ÿæ´»ä¹ æƒ¯æ˜¯ç–¾ç—…å‘ç”Ÿçš„é‡è¦è¯±å› ã€‚'
          },
          {
            title: 'å‘ç—…æœºç†',
            content: 'æ ¸å¿ƒåœ¨äºâ€œæ­£é‚ªäº¤äº‰â€ã€‚æ­£æ°”å­˜å†…ï¼Œé‚ªä¸å¯å¹²ï¼›é‚ªä¹‹æ‰€å‡‘ï¼Œå…¶æ°”å¿…è™šã€‚é˜´é˜³å¤±è°ƒã€æ°”æœºç´Šä¹±æ˜¯ç—…æœºå˜åŒ–çš„æ ¹æœ¬ã€‚'
          }
        ]
      },
      {
        id: '3',
        title: 'ä¸­åŒ»è¯Šæ–­ (è¯Š)',
        icon: 'ğŸ”',
        sections: [
          {
            title: 'å››è¯Šåˆå‚',
            content: 'æœ›ï¼ˆç¥è‰²å½¢æ€ã€èˆŒè±¡ï¼‰ã€é—»ï¼ˆå£°æ¯æ°”å‘³ï¼‰ã€é—®ï¼ˆå¯’çƒ­é¥®é£Ÿä¾¿æººï¼‰ã€åˆ‡ï¼ˆè„‰è±¡æŒ‰è¯Šï¼‰ã€‚å››è¯Šåˆå‚ï¼Œæ–¹èƒ½å…¨é¢æ”¶é›†ç—…æƒ…ã€‚'
          },
          {
            title: 'è¾¨è¯ä½“ç³»',
            content: 'ä»¥å…«çº²ï¼ˆé˜´é˜³è¡¨é‡Œå¯’çƒ­è™šå®ï¼‰ä¸ºæ€»çº²ï¼Œç»“åˆè„è…‘è¾¨è¯ã€å…­ç»è¾¨è¯ã€å«æ°”è¥è¡€è¾¨è¯ï¼Œç²¾å‡†é”å®šç—…ä½ã€ç—…æ€§ä¸ç—…åŠ¿ã€‚'
          }
        ]
      },
      {
        id: '4',
        title: 'æ²»åˆ™æ²»æ³• (æ³•)',
        icon: 'âš–ï¸',
        sections: [
          {
            title: 'æ²»æœªç—…æ€æƒ³',
            content: 'ä¸»å¼ â€œæœªç—…å…ˆé˜²ã€æ—¢ç—…é˜²å˜ã€ç˜¥åé˜²å¤â€ã€‚å¼ºè°ƒè°ƒèŠ‚é˜´é˜³å¹³è¡¡ï¼Œå¢å¼ºæœºä½“æŠµæŠ—åŠ›ï¼Œé˜²æ‚£äºæœªç„¶ã€‚'
          },
          {
            title: 'ä¸­åŒ»å…«æ³•',
            content: 'æ±—ï¼ˆå‘æ±—ï¼‰ã€åï¼ˆå‚¬åï¼‰ã€ä¸‹ï¼ˆæ³»ä¸‹ï¼‰ã€å’Œï¼ˆå’Œè§£ï¼‰ã€æ¸©ï¼ˆæ¸©é‡Œï¼‰ã€æ¸…ï¼ˆæ¸…çƒ­ï¼‰ã€æ¶ˆï¼ˆæ¶ˆå¯¼ï¼‰ã€è¡¥ï¼ˆè¡¥ç›Šï¼‰ï¼Œæ˜¯ä¸´åºŠé£è¯ç»„æ–¹çš„åŸºæœ¬å¤§æ³•ã€‚'
          }
        ]
      },
      {
        id: '5',
        title: 'ä¸­è¯ä¸æ–¹å‰‚ (è¯/æ–¹)',
        icon: 'ğŸŒ¿',
        sections: [
          {
            title: 'ä¸­è¯æ€§èƒ½',
            content: 'æŒæ¡â€œå››æ°”â€ï¼ˆå¯’å‡‰æ¸©çƒ­ï¼‰ä¸â€œäº”å‘³â€ï¼ˆé…¸è‹¦ç”˜è¾›å’¸ï¼‰ã€‚å‡é™æµ®æ²‰å®šè¶‹å‘ï¼Œå½’ç»åˆ™æ˜è¯æ•ˆæ‰€å½’ä¹‹è„è…‘ã€‚'
          },
          {
            title: 'æ–¹å‰‚é…ä¼',
            content: 'éµå¾ªâ€œå›è‡£ä½ä½¿â€åŸåˆ™ã€‚å›è¯ä¸»æ²»ï¼Œè‡£è¯è¾…åŠ©ï¼Œä½è¯å…¼æ²»æˆ–å‡æ¯’ï¼Œä½¿è¯è°ƒå’Œæˆ–å¼•ç»ï¼ŒååŒå¢æ•ˆã€‚'
          }
        ]
      },
      {
        id: '6',
        title: 'å…»ç”Ÿä¸éè¯ç‰©ç–—æ³•',
        icon: 'ğŸ§˜',
        sections: [
          {
            title: 'éè¯ç‰©ç–—æ³•',
            content: 'é’ˆç¸é€šç»æ´»ç»œï¼Œæ‹”ç½é€å¯’ç¥›æ¹¿ï¼Œæ¨æ‹¿è°ƒç†æ°”è¡€ã€‚è¿™äº›ç–—æ³•å…·æœ‰è§æ•ˆå¿«ã€å‰¯ä½œç”¨å°‘çš„ç‰¹ç‚¹ã€‚'
          },
          {
            title: 'é£Ÿç–—ä¸æƒ…å¿—',
            content: 'è¯é£ŸåŒæºï¼Œæ ¹æ®ä½“è´¨é€‰æ‹©è†³é£Ÿã€‚åŒæ—¶å¼ºè°ƒâ€œç²¾ç¥å†…å®ˆâ€ï¼Œè°ƒå’Œæƒ…å¿—ä»¥å…»è„è…‘ä¹‹ç²¾ï¼Œå®ç°å†…å¤–å…¼ä¿®ã€‚'
          }
        ]
      }
    ];
  }

  async getDb() {
    return {
      all: async (sql, params) => {
        if (sql.includes('rules')) return this.rules;
        if (sql.includes('syndromes')) return this.syndromes;
        if (sql.includes('prescriptions')) return this.prescriptions.filter(p => p.syndrome_id === params[0]);
        return [];
      },
      close: async () => {}
    };
  }

  async analyze(symptoms) {
    // ä» MongoDB è·å–æ‰€æœ‰è¯å‹æ•°æ®
    const syndromes = await Syndrome.find();
    
    // è·å–å½“å‰èŠ‚æ°”
    const nearestTerm = await this.getNearestSolarTerm();
    
    // 1. åŸºç¡€è¯„åˆ†é€»è¾‘
    let bestMatch = null;
    let maxScore = -1;

    for (const syndrome of syndromes) {
      let score = 0;
      // ä½¿ç”¨ embedded rules
      const syndromeRules = syndrome.rules || [];
      for (const rule of syndromeRules) {
        const userValue = symptoms[rule.field];
        if (Array.isArray(userValue)) {
          if (userValue.includes(rule.value)) score++;
        } else if (userValue === rule.value) {
          score++;
        }
      }
      if (score > maxScore) {
        maxScore = score;
        bestMatch = syndrome;
      }
    }

    // 2. æ·±åº¦è¾¨è¯æ¨ç†ç”Ÿæˆ (æ¨¡æ‹Ÿ AI åŒ»ç”Ÿäººæ ¼é€»è¾‘)
    // å®é™…åº”ç”¨ä¸­æ­¤å¤„åº”è°ƒç”¨ LLMï¼Œæ­¤å¤„æ ¹æ® symptoms åŠ¨æ€æ„å»ºä¸¥è°¨çš„ Markdown è¾“å‡º
    const reasoning = this.generateClinicalReasoning(symptoms, bestMatch);
    
    const result = {
      isDoctorMode: true, // æ ‡è®°ä¸ºåŒ»ç”Ÿæ¨¡å¼è¾“å‡º
      markdownReport: reasoning,
      disclaimer: this.aiConfig.doctorPersona.privacyDisclaimer,
      syndrome: bestMatch ? bestMatch.name : 'è¾¨è¯ä¸­...',
      // å…¼å®¹æ—§ç‰ˆ UI çš„åŸºç¡€å­—æ®µ
      treatment: bestMatch ? bestMatch.treatment_principle : 'è¯·å’¨è¯¢åŒ»å¸ˆ',
      lifestyle: bestMatch ? [...bestMatch.lifestyle_advice.split('ï¼›'), `å½“å‰æ­£å€¼${nearestTerm.name}èŠ‚æ°”ï¼Œå»ºè®®ï¼š${nearestTerm.living}`] : []
    };

    // è®°å½•è¯Šæ–­
    if (bestMatch) {
      // è®°å½•è¯Šæ–­ç»“æœåˆ° MongoDB
      try {
        await DiagnosisRecord.create({
          syndrome: bestMatch.name,
          timestamp: Date.now()
        });
      } catch (err) {
        console.error('Failed to save diagnosis record:', err);
      }
    }

    return result;
  }

  // æ¨¡æ‹Ÿ AI åŒ»ç”Ÿçš„æ€ç»´é“¾æ¨ç†è¿‡ç¨‹
  generateClinicalReasoning(symptoms, match) {
    const { fever, chills, sweat, cough, phlegm, stomach, sleep, soreThroat, nasal, thirst, stool } = symptoms;
    
    let analysisLines = [];
    let bagang = []; // å…«çº²
    let liujing = ''; // å…­ç»

    // æ¶å¯’å‘çƒ­åˆ†æ
    if (chills === 'heavy' && fever === 'light') {
      analysisLines.push('- å¯’çƒ­ï¼šç”¨æˆ·è¡¨ç°ä¸ºæ¶å¯’é‡ã€å‘çƒ­è½»ï¼Œæ­¤ä¹ƒå¯’é‚ªæŸè¡¨ï¼Œå«é˜³è¢«éä¹‹è±¡ã€‚');
      bagang.push('è¡¨', 'å¯’', 'å®');
      liujing = 'å¤ªé˜³ç—…ï¼ˆä¼¤å¯’ï¼‰';
    } else if (fever === 'heavy' && chills === 'light') {
      analysisLines.push('- å¯’çƒ­ï¼šå‘çƒ­é‡ã€å¾®æ¶é£å¯’ï¼Œæç¤ºå¤–æ„Ÿé£çƒ­ï¼Œä¼¤åŠå«åˆ†ã€‚');
      bagang.push('è¡¨', 'çƒ­', 'å®');
      liujing = 'å«åˆ†è¯ï¼ˆé£çƒ­ï¼‰';
    }

    // æ±—æ¶²åˆ†æ
    if (sweat === 'none') {
      analysisLines.push('- æ±—æ¶²ï¼šæ— æ±—ï¼Œè¯´æ˜è… ç†é—­å¡ï¼Œå¯’é‚ªæŸè¡¨è¾ƒç´§ã€‚');
    } else if (sweat === 'partial') {
      analysisLines.push('- æ±—æ¶²ï¼šå¾®æ±—ï¼Œæç¤ºçƒ­é‚ªç–æ³„è… ç†ï¼Œæˆ–æ°”è™šä¸å›ºã€‚');
    }

    // å±€éƒ¨ç—‡çŠ¶åˆ†æ
    if (soreThroat === 'heavy') analysisLines.push('- å’½å–‰ï¼šå’½å–‰çº¢è‚¿ç–¼ç—›æ˜æ˜¾ï¼Œçƒ­æ¯’å£…ç››äºä¸Šã€‚');
    if (nasal === 'clear') analysisLines.push('- é¼»å¡ï¼šæµæ¸…æ¶•ï¼Œå±å¯’é‚ªåœ¨è¡¨ä¹‹å…¸å‹è¡¨ç°ã€‚');
    if (thirst === 'heavy') analysisLines.push('- å£æ¸´ï¼šæ¸´å–œå†·é¥®ï¼Œå†…æœ‰é‡Œçƒ­è€—ä¼¤æ´¥æ¶²ã€‚');
    if (stool === 'constipated') analysisLines.push('- äºŒä¾¿ï¼šå¤§ä¾¿å¹²ç»“ï¼Œæç¤ºé‡Œçƒ­ç»“å®æˆ–é˜´æ¶²ä¸è¶³ã€‚');

    const bagangStr = bagang.length > 0 ? bagang.join('') : 'è¡¨è¯å¾…å®š';
    const mainSyndrome = match ? match.name : 'å¤–æ„Ÿè¯å€™';

    // ç”Ÿæˆé’ˆç¸ç©´ä½æ¨è
    const acupoints = this.getAcupointRecommendation(mainSyndrome);
    // ç”Ÿæˆé£Ÿç–—å»ºè®®
    const dietary = this.getDietaryRecommendation(mainSyndrome);

    return `## åˆæ­¥è¾¨è¯åˆ†æ
1. **å¯’çƒ­è¾¨æ**ï¼šæ ¹æ®ç”¨æˆ·ä¸»è¯‰ï¼Œ${analysisLines.join('\n')}
2. **ç—…ä½ä¸ç—…æ€§**ï¼šç—…ä½åœ¨è¡¨ï¼Œé‚ªæ­£äº¤äº‰ã€‚ä»å…«çº²è¾¨è¯çœ‹ï¼Œå±äº**${bagangStr}**ã€‚
3. **æ¨ç†è¿‡ç¨‹**ï¼š${liujing ? `ç»“åˆ${liujing}ç†è®ºï¼Œ` : ''}å› é‚ªæ°”ä¾µè¢­ï¼Œå«å¤–åŠŸèƒ½å¤±è°ƒï¼Œæ•…è§ä¸Šè¿°è¯¸ç—‡ã€‚è‹¥ä¸åŠæ—¶ç–è§£ï¼Œææœ‰å…¥é‡ŒåŒ–çƒ­ä¹‹åŠ¿ã€‚

## è¯å‹ç»“è®º
1. **${mainSyndrome}**ï¼ˆå¯èƒ½æ€§ 90%ï¼‰ï¼šä¾æ®ã€Šä¼¤å¯’è®ºã€‹æˆ–ã€Šæ¸©ç—…æ¡è¾¨ã€‹å¤–æ„Ÿç¯‡ç›¸å…³æ¡æ–‡ï¼Œç—‡çŠ¶é«˜åº¦å¥‘åˆã€‚
2. **æ°”è™šæ„Ÿå†’**ï¼ˆå¯èƒ½æ€§ 10%ï¼‰ï¼šè‹¥ç—…ç¨‹è¿å»¶ï¼Œéœ€è€ƒè™‘æ‚£è€…ç´ ä½“è™šå¼±ä¹‹å¯èƒ½ã€‚

${acupoints}

${dietary}

## å»ºè®®æ–¹æ¡ˆ
- **æ–¹è¯æ¨è**ï¼š
  - é¦–é€‰ï¼š**${match ? match.treatment_principle.includes('æ¸…çƒ­') ? 'é“¶ç¿˜æ•£' : 'è†é˜²è´¥æ¯’æ•£' : 'æ„Ÿå†’æ¸…çƒ­é¢—ç²’'}**ã€‚
  - å‡ºå¤„ï¼š${match ? match.treatment_principle.includes('æ¸…çƒ­') ? 'ã€Šæ¸©ç—…æ¡è¾¨ã€‹' : 'ã€Šæ‘„ç”Ÿä¼—å¦™æ–¹ã€‹' : 'ç°ä»£ç»éªŒæ–¹'}ã€‚
- **è°ƒæŠ¤æ³¨æ„**ï¼š
  - é¥®é£Ÿå®œæ¸…æ·¡ï¼Œå¿Œè¾›è¾£æ²¹è…»åŠç”Ÿå†·ã€‚
  - é¿é£ä¿æš–ï¼Œä¿è¯å……è¶³ç¡çœ ï¼Œå¤šé¥®æ¸©å¼€æ°´ã€‚
- **å°±åŒ»è­¦ç¤º**ï¼š
  - è‹¥å‡ºç°é«˜çƒ­æŒç»­ä¸é€€ï¼ˆ>39â„ƒï¼‰ã€ç¥å¿—æ¨¡ç³Šã€å‰§çƒˆå¤´ç—›æˆ–å‘¼å¸å›°éš¾ï¼Œè¯·ç«‹å³å‰å¾€åŒ»é™¢å°±è¯Šã€‚`;
  }

  // è·å–ç©´ä½æ¨èé€»è¾‘
  getAcupointRecommendation(syndrome) {
    const acupointData = {
      'é£çƒ­æ„Ÿå†’': `## æ¨èç©´ä½
1. å¤§æ¤ï¼ˆç£è„‰ï¼‰
   - å®šä½ï¼šåæ­£ä¸­çº¿ä¸Šï¼Œç¬¬7é¢ˆæ¤æ£˜çªä¸‹å‡¹é™·ä¸­ã€‚
   - åŠŸæ•ˆï¼šæ¸…çƒ­è§£è¡¨ï¼Œç–é£æ•£é‚ªã€‚
   - æ“ä½œæ–¹æ³•ï¼šæŒ‰æ‰3-5åˆ†é’Ÿï¼Œæˆ–æ‹”ç½ï¼Œäº¦å¯è‰¾ç¸10-15åˆ†é’Ÿã€‚
   - ç¦å¿Œï¼šå±€éƒ¨çš®è‚¤ç ´æŸæˆ–ä¸¥é‡å¿ƒè„ç—…è€…ç¦ç”¨ã€‚

2. æ›²æ± ï¼ˆæ‰‹é˜³æ˜å¤§è‚ ç»ï¼‰
   - å®šä½ï¼šå±ˆè‚˜ï¼Œè‚˜æ¨ªçº¹å¤–ä¾§ç«¯ï¼Œå°ºæ³½ä¸è‚±éª¨å¤–ä¸Šé«è¿çº¿çš„ä¸­ç‚¹ã€‚
   - åŠŸæ•ˆï¼šæ¸…çƒ­æ³»ç«ï¼Œç–æ•£é£çƒ­ã€‚
   - æ“ä½œæ–¹æ³•ï¼šæŒ‡å°–ç”¨åŠ›æŒ‰æ‰ï¼Œæ¯ä¾§3-5åˆ†é’Ÿã€‚
   - ç¦å¿Œï¼šå­•å¦‡æ…ç”¨å¼ºåˆºæ¿€ã€‚

3. å¤–å…³ï¼ˆæ‰‹å°‘é˜³ä¸‰ç„¦ç»ï¼‰
   - å®šä½ï¼šåœ¨å‰è‡‚ååŒºï¼Œè…•èƒŒä¾§è¿œç«¯æ¨ªçº¹ä¸Š2å¯¸ï¼Œå°ºéª¨ä¸æ¡¡éª¨é—´éš™ä¸­ç‚¹ã€‚
   - åŠŸæ•ˆï¼šè§£è¡¨æ¸…çƒ­ï¼Œé€šç»æ´»ç»œã€‚
   - æ“ä½œæ–¹æ³•ï¼šç‚¹æŒ‰æˆ–æ‰æŒ‰ï¼Œå±€éƒ¨æœ‰é…¸èƒ€æ„Ÿä¸ºå®œã€‚
   - ç¦å¿Œï¼šå±€éƒ¨éª¨æŠ˜æˆ–ä¸¥é‡æ°´è‚¿è€…ä¸å®œã€‚`,
      'é£å¯’æ„Ÿå†’': `## æ¨èç©´ä½
1. é£æ± ï¼ˆè¶³å°‘é˜³èƒ†ç»ï¼‰
   - å®šä½ï¼šåœ¨é¡¹éƒ¨ï¼Œèƒ¸é”ä¹³çªè‚Œä¸æ–œæ–¹è‚Œä¸Šç«¯ä¹‹é—´çš„å‡¹é™·ä¸­ã€‚
   - åŠŸæ•ˆï¼šç–é£æ•£å¯’ï¼Œæ¸…å¤´ç›®ã€‚
   - æ“ä½œæ–¹æ³•ï¼šåŒæ‰‹æ‹‡æŒ‡æŒ‰æ‰ï¼Œå‘å¯¹ä¾§çœ¼ç›æ–¹å‘ç”¨åŠ›ã€‚
   - ç¦å¿Œï¼šä¸¥ç¦å‚ç›´å‘å†…æ·±åˆºæˆ–è¿‡åº¦ç”¨åŠ›ã€‚

2. åˆè°·ï¼ˆæ‰‹é˜³æ˜å¤§è‚ ç»ï¼‰
   - å®šä½ï¼šåœ¨æ‰‹èƒŒï¼Œç¬¬1ã€2æŒéª¨é—´ï¼Œå½“ç¬¬2æŒéª¨æ¡¡ä¾§çš„ä¸­ç‚¹å¤„ã€‚
   - åŠŸæ•ˆï¼šè§£è¡¨æ•£å¯’ï¼Œæ­¢ç—›ã€‚
   - æ“ä½œæ–¹æ³•ï¼šç”¨åŠ›æŒ‰æ‰ï¼Œæœ‰æ˜æ˜¾é…¸èƒ€æ„Ÿä¸ºå®œã€‚
   - ç¦å¿Œï¼šå­•å¦‡ç¦ç”¨ã€‚

3. åˆ—ç¼ºï¼ˆæ‰‹å¤ªé˜´è‚ºç»ï¼‰
   - å®šä½ï¼šåœ¨å‰è‡‚ï¼Œè…•èƒŒä¾§è¿œç«¯æ¨ªçº¹ä¸Š1.5å¯¸ï¼Œæ‹‡çŸ­å±•è‚Œè…±ä¸è‚±æ¡¡è‚Œè…±ä¹‹é—´ã€‚
   - åŠŸæ•ˆï¼šå®£è‚ºè§£è¡¨ï¼Œé€šç»æ´»ç»œã€‚
   - æ“ä½œæ–¹æ³•ï¼šä¸¤æ‰‹è™å£äº¤å‰ï¼Œé£ŸæŒ‡å°–æ‰€åˆ°çš„å‡¹é™·å¤„å³æ˜¯ï¼ŒæŒ‰æ‰3-5åˆ†é’Ÿã€‚
   - ç¦å¿Œï¼šå±€éƒ¨ä¼¤å£æœªæ„ˆåˆè€…ç¦ç”¨ã€‚`
    };
    return acupointData[syndrome] || '## æ¨èç©´ä½\næš‚æ— é’ˆå¯¹è¯¥è¯å‹çš„ç‰¹å®šç©´ä½æ¨èï¼Œå»ºè®®å’¨è¯¢ä¸“ä¸šé’ˆç¸å¸ˆã€‚';
  }

  // è·å–é£Ÿç–—å»ºè®®é€»è¾‘
  getDietaryRecommendation(syndrome) {
    const dietaryData = {
      'é£çƒ­æ„Ÿå†’': `## é£Ÿç–—å»ºè®®
æ–¹ä¸€ï¼šæ¡‘èŠé¥®ï¼ˆç®€åŒ–ç‰ˆï¼‰
- ææ–™ï¼šæ¡‘å¶10gï¼ŒèŠèŠ±10gï¼Œè–„è·5gã€‚
- åšæ³•ï¼šå°†ææ–™æ´—å‡€ï¼Œå¼€æ°´å†²æ³¡æˆ–ç…®æ²¸5åˆ†é’Ÿï¼Œä»£èŒ¶é¥®ã€‚
- åŠŸæ•ˆï¼šç–é£æ¸…çƒ­ï¼Œå®£è‚ºæ­¢å’³ã€‚
- æ³¨æ„ï¼šèƒƒå¯’ã€æ˜“è…¹æ³»è€…ä¸å®œé•¿æœŸé¥®ç”¨ã€‚

æ–¹äºŒï¼šè–„è·æ¢¨ç²¥
- ææ–™ï¼šè–„è·5gï¼Œé¸­æ¢¨1ä¸ªï¼Œç²³ç±³100gã€‚
- åšæ³•ï¼šå…ˆç…®ç±³ç²¥ï¼Œç²¥æˆååŠ å…¥æ¢¨å—ï¼Œæœ€åæ”¾å…¥è–„è·ç…®æ²¸å³å¯ã€‚
- åŠŸæ•ˆï¼šæ¸…çƒ­ç”Ÿæ´¥ï¼Œåˆ©å’½æ­¢å’³ã€‚
- æ³¨æ„ï¼šç³–å°¿ç—…æ‚£è€…æ…ç”¨ã€‚`,
      'é£å¯’æ„Ÿå†’': `## é£Ÿç–—å»ºè®®
æ–¹ä¸€ï¼šç”Ÿå§œçº¢ç³–æ±¤
- ææ–™ï¼šç”Ÿå§œ3-5ç‰‡ï¼Œçº¢ç³–é€‚é‡ã€‚
- åšæ³•ï¼šç”Ÿå§œæ´—å‡€åˆ‡ä¸ï¼ŒåŠ æ°´ç…®æ²¸5-10åˆ†é’Ÿï¼ŒåŠ å…¥çº¢ç³–åŒ–å¼€ã€‚
- åŠŸæ•ˆï¼šè¾›æ¸©è§£è¡¨ï¼Œæ•£å¯’æš–èƒƒã€‚
- æ³¨æ„ï¼šä½“è´¨åçƒ­ã€å£å¹²å’½ç—›è€…ä¸å®œã€‚

æ–¹äºŒï¼šè‘±ç™½ç²¥
- ææ–™ï¼šè‘±ç™½3-5æ®µï¼Œç³¯ç±³æˆ–ç²³ç±³50gã€‚
- åšæ³•ï¼šå…ˆå°†ç±³ç…®ç†Ÿï¼ŒåŠ å…¥è‘±ç™½å†ç…®5åˆ†é’Ÿå³å¯ã€‚
- åŠŸæ•ˆï¼šå‘æ•£é£å¯’ï¼Œå’Œèƒƒã€‚
- æ³¨æ„ï¼šæ±—å‡ºè¿‡å¤šè€…ä¸å®œã€‚`
    };
    return dietaryData[syndrome] || '## é£Ÿç–—å»ºè®®\næš‚æ— é’ˆå¯¹è¯¥è¯å‹çš„ç‰¹å®šé£Ÿç–—å»ºè®®ï¼Œå»ºè®®éµå¾ªæ¸…æ·¡é¥®é£ŸåŸåˆ™ã€‚';
  }

  // ç—‡çŠ¶å¯¹ç…§åˆ†æé€»è¾‘
  async analyzeSymptomComparison(symptom) {
    // ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾åŒ¹é…çš„ç—‡çŠ¶
    const allSymptoms = await SymptomComparison.distinct('symptomName');
    const matchedSymptom = allSymptoms.find(key => symptom.indexOf(key) !== -1);
    
    let comparisons = [];
    if (matchedSymptom) {
      comparisons = await SymptomComparison.find({ symptomName: matchedSymptom });
    }

    return {
      symptom: symptom,
      comparisons: comparisons,
      disclaimer: this.aiConfig.symptomComparisonConfig.disclaimer
    };
  }

  // ç©´ä½ç®¡ç†æ–¹æ³•
  async getAcupunctureData() {
    return await Acupuncture.find();
  }

  async updateAcupunctureData(data) {
    await Acupuncture.deleteMany({});
    if (Array.isArray(data)) {
      await Acupuncture.insertMany(data);
    }
    return true;
  }

  // ç—‡çŠ¶å¯¹ç…§ç®¡ç†æ–¹æ³•
  async getSymptomComparisonData() {
    const all = await SymptomComparison.find();
    const result = {};
    all.forEach(item => {
      if (!result[item.symptomName]) result[item.symptomName] = [];
      result[item.symptomName].push(item);
    });
    return result;
  }

  async updateSymptomComparisonData(data) {
    await SymptomComparison.deleteMany({});
    const items = [];
    for (const symptomName in data) {
      data[symptomName].forEach(item => {
        const { _id, ...rest } = item.toObject ? item.toObject() : item;
        items.push({ ...rest, symptomName });
      });
    }
    if (items.length > 0) {
      await SymptomComparison.insertMany(items);
    }
    return true;
  }

  // è·å–ä¸­åŒ»åŸºç¡€çŸ¥è¯†æ•°æ®
  async getKnowledgeData() {
    return await Knowledge.find();
  }

  async updateKnowledgeData(data) {
    await Knowledge.deleteMany({});
    if (Array.isArray(data)) {
      await Knowledge.insertMany(data);
    }
    return true;
  }

  // æ–°å¢ï¼šèˆŒè¯Šè„‰è¯Šæ·±åº¦åˆ†æé€»è¾‘
  analyzeTongueAndPulse(description, symptoms, pulse = '') {
    // åŸºç¡€æ ¡éªŒ - é™ä½å­—æ•°é™åˆ¶ï¼Œå…è®¸æ›´ç®€çŸ­çš„æè¿°ï¼ˆå¦‚â€œèˆŒçº¢è‹”é»„â€ï¼‰
    if (!description || description.length < 2) {
      return "ç›®å‰çš„æè¿°ä¿¡æ¯è¾ƒå°‘ï¼Œå»ºè®®æ‚¨è¯¦ç»†è¯´æ˜èˆŒè´¨çš„é¢œè‰²ï¼ˆå¦‚æ·¡çº¢ã€çº¢ã€ç»›ç´«ï¼‰ã€èˆŒè‹”çš„åšè–„ä¸é¢œè‰²ï¼ˆå¦‚è–„ç™½ã€é»„è…»ï¼‰ã€ä»¥åŠèˆŒä½“æ˜¯å¦æœ‰é½¿ç—•æˆ–è£‚çº¹ç­‰ç‰¹å¾ã€‚";
    }

    let tongueAnalysis = "";
    let synthesis = "";
    let syndromeConclusion = "";
    let advice = "";

    // 1. èˆŒè±¡è¯¦ç»†è¾¨æ - ä½¿ç”¨ indexOf æé«˜å…¼å®¹æ€§
    const hasRed = description.indexOf("çº¢") !== -1;
    const hasYellow = description.indexOf("é»„") !== -1;
    const hasGreasy = description.indexOf("è…»") !== -1;
    const hasPale = description.indexOf("æ·¡") !== -1 || description.indexOf("ç™½") !== -1;
    const hasTeethMark = description.indexOf("é½¿ç—•") !== -1;
    const hasThin = description.indexOf("è–„") !== -1;
    const hasPurple = description.indexOf("ç´«") !== -1 || description.indexOf("æš—") !== -1;

    if (hasRed && (hasYellow || hasGreasy)) {
      tongueAnalysis = "ã€èˆŒè±¡åˆ†æã€‘èˆŒè´¨çº¢ï¼Œè‹”é»„è…»ã€‚åœ¨ä¸­åŒ»è¯Šæ–­ä¸­ï¼ŒèˆŒçº¢ä¸»çƒ­ï¼Œè‹”é»„ä¸»çƒ­ï¼Œè…»è‹”ä¸»æ¹¿ã€‚è¿™åæ˜ äº†ä½“å†…å­˜åœ¨â€œæ¹¿çƒ­å†…è•´â€çš„æƒ…å†µï¼Œå¸¸è§äºä¸­ç„¦è„¾èƒƒæˆ–ä¸‹ç„¦å¤§è‚ å—é˜»ã€‚";
      synthesis = "ã€è¾¨è¯å½’çº³ã€‘æ¹¿çƒ­å†…è•´è¯ï¼ˆé‡Œã€å®ã€çƒ­ï¼‰ã€‚";
      syndromeConclusion = "1. **è„¾èƒƒæ¹¿çƒ­**ï¼šè¡¨ç°ä¸ºå£è‹¦ã€çº³å‘†ã€å¤§ä¾¿é»æ»ã€‚ä¾æ®ï¼šèˆŒçº¢è‹”é»„è…»æ˜¯å…¸å‹æŒ‡å¾ã€‚\n2. **è‚èƒ†æ¹¿çƒ­**ï¼šè‹¥ä¼´æœ‰èƒè‚‹èƒ€ç—›ã€ç›®é»„ã€‚ä¾æ®ï¼šçƒ­é‚ªä¾µè¢­è‚èƒ†ç»ç»œã€‚";
      advice = "ã€è°ƒç†å»ºè®®ã€‘å®œæ¸…çƒ­åŒ–æ¹¿ã€‚ç©´ä½å¯æŒ‰æ‰**ä¸°éš†**ï¼ˆç¥›æ¹¿è¦ç©´ï¼‰ã€**è¶³ä¸‰é‡Œ**ï¼ˆè°ƒç†è„¾èƒƒï¼‰ã€‚é£Ÿç–—æ¨èï¼šå†¬ç“œè–ç±³æ±¤ã€èŒ¯è‹“ç²¥ã€‚";
    } else if (hasPale && hasTeethMark) {
      tongueAnalysis = "ã€èˆŒè±¡åˆ†æã€‘èˆŒè´¨æ·¡ç™½ï¼Œè¾¹ç¼˜æœ‰é½¿ç—•ã€‚èˆŒæ·¡ä¸»è™šã€ä¸»å¯’ï¼Œé½¿ç—•æç¤ºè„¾è™šä¸èƒ½è¿åŒ–æ°´æ¹¿ï¼Œå¯¼è‡´èˆŒä½“èƒ–å¤§å—ç‰™é½¿å‹è¿«ã€‚è¿™åæ˜ äº†â€œè„¾æ°”è™šå¼±ï¼Œæ¹¿æ°”å†…åœâ€çš„æƒ…å†µã€‚";
      synthesis = "ã€è¾¨è¯å½’çº³ã€‘è„¾æ°”è™šå¼±è¯ï¼ˆé‡Œã€è™šã€å¯’ï¼‰ã€‚";
      syndromeConclusion = "1. **è„¾æ°”è™š**ï¼šè¡¨ç°ä¸ºç¥ç–²ä¹åŠ›ã€é£Ÿæ¬²ä¸æŒ¯ã€‚ä¾æ®ï¼šèˆŒæ·¡é½¿ç—•æ˜¯æ°”è™šæ¹¿ç››çš„å…¸å‹è¡¨ç°ã€‚\n2. **é˜³è™šæ¹¿ç››**ï¼šè‹¥ä¼´æœ‰ç•å¯’æ€•å†·ã€ä¸‹è‚¢æµ®è‚¿ã€‚ä¾æ®ï¼šé˜³æ°”ä¸è¶³ï¼Œæ°´æ¹¿ä¸åŒ–ã€‚";
      advice = "ã€è°ƒç†å»ºè®®ã€‘å®œå¥è„¾ç›Šæ°”ã€‚ç©´ä½å¯æŒ‰æ‰**è¶³ä¸‰é‡Œ**ã€**è„¾ä¿**ã€‚é£Ÿç–—æ¨èï¼šå±±è¯å¤§æ£ç²¥ã€é»„èŠªç‚–é¸¡ã€‚";
    } else if (hasPurple) {
      tongueAnalysis = "ã€èˆŒè±¡åˆ†æã€‘èˆŒè´¨ç´«æš—æˆ–æœ‰ç˜€ç‚¹ã€‚ç´«æš—ä¸»ç˜€ï¼Œåæ˜ è¡€æ¶²è¿è¡Œä¸ç•…ï¼Œå¯èƒ½å­˜åœ¨â€œæ°”æ»è¡€ç˜€â€æˆ–å¯’å‡è¡€ç˜€çš„æƒ…å†µã€‚";
      synthesis = "ã€è¾¨è¯å½’çº³ã€‘è¡€ç˜€è¯ã€‚";
      syndromeConclusion = "1. **æ°”æ»è¡€ç˜€**ï¼šè¡¨ç°ä¸ºå±€éƒ¨åˆºç—›ã€æƒ…ç»ªæŠ‘éƒã€‚ä¾æ®ï¼šèˆŒè´¨æš—æç¤ºè¡€è¡Œè¿Ÿç¼“ã€‚\n2. **å¯’å‡è¡€ç˜€**ï¼šè‹¥ä¼´æœ‰æ‰‹è„šå†°å‡‰ã€‚ä¾æ®ï¼šå¯’é‚ªæ”¶å¼•å¯¼è‡´è¡€è„‰ç˜€æ»ã€‚";
      advice = "ã€è°ƒç†å»ºè®®ã€‘å®œæ´»è¡€åŒ–ç˜€ã€‚ç©´ä½å¯æŒ‰æ‰**åˆè°·**ã€**å¤ªå†²**ï¼ˆå¼€å››å…³ï¼‰ã€‚é£Ÿç–—æ¨èï¼šå±±æ¥‚çº¢ç³–æ°´ã€‚";
    } else if (hasRed && hasThin) {
      tongueAnalysis = "ã€èˆŒè±¡åˆ†æã€‘èˆŒè´¨çº¢ï¼Œè‹”è–„ã€‚æç¤ºä½“å†…å¯èƒ½æœ‰è½»å¾®çƒ­é‚ªï¼Œæˆ–å¤„äºå¤–æ„Ÿé£çƒ­åˆæœŸï¼Œçƒ­é‚ªå°šæœªä¼¤åŠæ´¥æ¶²ã€‚";
      synthesis = "ã€è¾¨è¯å½’çº³ã€‘è¡¨çƒ­è¯æˆ–è½»åº¦é‡Œçƒ­ã€‚";
      syndromeConclusion = "1. **é£çƒ­çŠ¯è‚º**ï¼šè¡¨ç°ä¸ºå‘çƒ­ã€å’½ç—›ã€‚ä¾æ®ï¼šèˆŒçº¢è‹”è–„æ˜¯çƒ­é‚ªåœ¨è¡¨çš„è¡¨ç°ã€‚";
      advice = "ã€è°ƒç†å»ºè®®ã€‘å®œç–é£æ¸…çƒ­ã€‚å»ºè®®å¤šå–æ¸©å¼€æ°´ï¼Œå¯ç”¨é‡‘é“¶èŠ±ã€èŠèŠ±æ³¡èŒ¶ã€‚";
    } else {
      tongueAnalysis = "ã€èˆŒè±¡åˆ†æã€‘å½“å‰çš„èˆŒè±¡æè¿°è¾ƒä¸ºç»¼åˆã€‚å»ºè®®è§‚å¯ŸèˆŒä½“æ˜¯å¦çµæ´»ã€æ˜¯å¦æœ‰è£‚çº¹ï¼Œä»¥åŠèˆŒåº•è„‰ç»œæ˜¯å¦æ€’å¼ ã€‚";
      synthesis = "ã€è¾¨è¯å½’çº³ã€‘æ°”è¡€çŠ¶æ€å¾…è¿›ä¸€æ­¥æ˜ç¡®ã€‚";
      syndromeConclusion = "1. **æ°”è¡€ä¸å’Œ**ï¼šå¯èƒ½æ˜¯è°ƒç†æœŸçš„è¿‡æ¸¡çŠ¶æ€ã€‚\n2. **è‚éƒæ°”æ»**ï¼šè‹¥æƒ…ç»ªæ³¢åŠ¨è¾ƒå¤§æ—¶è§‚å¯ŸèˆŒè±¡å¯èƒ½æœ‰æ‰€å˜åŒ–ã€‚";
      advice = "ã€è°ƒç†å»ºè®®ã€‘ä¿æŒå¿ƒæƒ…èˆ’ç•…ï¼Œæ—©ç¡æ—©èµ·ã€‚å»ºè®®ä½¿ç”¨â€œæ™ºèƒ½é—®è¯Šâ€è¿›è¡Œæ›´å…¨é¢çš„ç—‡çŠ¶åˆ†æã€‚";
    }

    // ç»“åˆè„‰è±¡
    if (pulse) {
      tongueAnalysis += `\nã€è„‰è±¡è¡¥å……ã€‘è„‰è§â€œ${pulse}â€ã€‚`;
      if (pulse.indexOf("æ»‘") !== -1 || pulse.indexOf("æ•°") !== -1) synthesis += " è„‰è±¡æ»‘æ•°è¿›ä¸€æ­¥è¯å®äº†çƒ­é‚ªæˆ–ç—°æ¹¿çš„å­˜åœ¨ã€‚";
      if (pulse.indexOf("æ²‰") !== -1 || pulse.indexOf("ç»†") !== -1) synthesis += " è„‰è±¡æ²‰ç»†æç¤ºç—…ä½åœ¨é‡Œï¼Œä¸”æ°”è¡€ç›¸å¯¹äºè™šã€‚";
      if (pulse.indexOf("å¼¦") !== -1) synthesis += " è„‰è±¡å¼¦ç¡¬å¤šè§äºè‚æ°”éƒç»“æˆ–ç—›è¯ã€‚";
    }

    return `## AI ä¸­åŒ»è¾¨è¯åˆ†ææŠ¥å‘Š\n\n${tongueAnalysis}\n\n${synthesis}\n\n${syndromeConclusion}\n\n${advice}\n\n> **ä¸“å®¶æç¤º**ï¼šæœ¬åˆ†æç”± AI åŸºäºä¸­åŒ»å…¸ç±æ¨ç†ç”Ÿæˆï¼Œä»…ä¾›å¥åº·å’¨è¯¢å‚è€ƒã€‚ç”±äºä¸­åŒ»è®²ç©¶â€œæœ›é—»é—®åˆ‡â€å››è¯Šåˆå‚ï¼Œå»ºè®®æ‚¨æ‰¾ä¸“ä¸šä¸­åŒ»å¸ˆè¿›è¡Œé¢å¯¹é¢è¯Šç–—ã€‚`;
  }

  // AI èŠå¤©é—®è¯Šå¤„ç†
  async processChat(messages) {
    const lastUserMessage = messages[messages.length - 1].content;
    const msg = lastUserMessage || "";
    console.log('Processing chat message:', msg);
    
    // æå–å…³é”®å­—è¯†åˆ«é€»è¾‘
    const hasTongue = msg.indexOf("èˆŒ") !== -1 || msg.indexOf("è‹”") !== -1;
    const hasPulse = msg.indexOf("è„‰") !== -1;
    const isConsultation = msg.indexOf("ä¼šè¯Š") !== -1 || msg.indexOf("å’¨è¯¢") !== -1 || msg.indexOf("çœ‹ç—…") !== -1;

    // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ä¸”å†…å®¹ä¸º initï¼Œæˆ–è€…ä¸å«å…³é”®å­—çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œè¿”å›æ¬¢è¿è¯­
    if (messages.length === 1 && (msg === 'init' || (!hasTongue && !hasPulse && !isConsultation))) {
      return {
        reply: this.aiConfig.chatPersona.firstMessage,
        suggestions: ["èˆŒè´¨çº¢ï¼Œè‹”é»„è…»", "èˆŒæ·¡æœ‰é½¿ç—•", "æˆ‘æœ€è¿‘æœ‰ç‚¹æ„Ÿå†’", "æ€»è§‰å¾—èº«ä½“å¾ˆç´¯"],
        shouldEnd: false
      };
    }

    let reply = "";
    let suggestions = [];
    let shouldEnd = false;

    // æ¨¡æ‹ŸåŸºäºä¸Šä¸‹æ–‡çš„äº¤äº’å¼å¼•å¯¼é€»è¾‘
    if (hasTongue || hasPulse || isConsultation) {
      console.log('Tongue/Pulse/Consultation detected in:', msg);
      // æ£€æŸ¥æ˜¯å¦åªæ˜¯æƒ³å¼€å§‹ï¼Œä½†æ²¡æä¾›å…·ä½“æè¿°
      const isJustStarting = isConsultation || 
                            (msg.length < 10 && (msg.indexOf("æ€ä¹ˆçœ‹") !== -1 || msg.indexOf("è¿›è¡Œ") !== -1)) || 
                            msg === "æˆ‘æƒ³è¿›è¡ŒèˆŒè¯Šè„‰è¯Š" || 
                            msg === "è¿›è¡ŒèˆŒè¯Š" ||
                            (msg.length <= 3 && (hasTongue || hasPulse) && msg.indexOf("çº¢") === -1 && msg.indexOf("é»„") === -1 && msg.indexOf("ç™½") === -1);

      if (isJustStarting && msg.indexOf("èˆŒ") === -1 && msg.indexOf("è„‰") === -1) {
        return {
          reply: "å¥½çš„ï¼Œæˆ‘æ˜¯æ‚¨çš„ä¸­åŒ» AI åŠ©æ‰‹ã€‚è¯·é—®æ‚¨æ˜¯æƒ³è¿›è¡ŒèˆŒè„‰ä¼šè¯Šå—ï¼Ÿè¯·è¯¦ç»†æè¿°ä¸€ä¸‹æ‚¨çš„èˆŒè±¡ï¼ˆé¢œè‰²ã€è‹”è´¨ï¼‰å’Œè„‰è±¡ï¼Œæˆ–è€…å‘Šè¯‰æˆ‘æ‚¨å“ªé‡Œä¸èˆ’æœã€‚",
          suggestions: ["æˆ‘æƒ³è¿›è¡ŒèˆŒè¯Šè„‰è¯Š", "æˆ‘æœ€è¿‘æ„Ÿå†’äº†", "èˆŒçº¢è‹”é»„"],
          shouldEnd: false
        };
      }
      
      if (isJustStarting) {
        return {
          reply: "å¥½çš„ï¼Œè¯·æ‚¨è¯¦ç»†æè¿°ä¸€ä¸‹æ‚¨çš„èˆŒè±¡ï¼ˆå¦‚èˆŒå¤´é¢œè‰²æ˜¯æ·¡çº¢ã€æ·±çº¢è¿˜æ˜¯ç´«æš—ï¼ŸèˆŒè‹”æ˜¯è–„ç™½ã€é»„åšè¿˜æ˜¯è…»ï¼Ÿï¼‰ä»¥åŠè„‰è±¡ï¼ˆå¦‚è·³åŠ¨æœ‰åŠ›è¿˜æ˜¯æ— åŠ›ï¼Ÿå¿«è¿˜æ˜¯æ…¢ï¼Ÿï¼‰ï¼Œå¦‚æœæœ‰å…¶ä»–ä¸èˆ’æœä¹Ÿå¯ä»¥ä¸€å¹¶å‘Šè¯‰æˆ‘ã€‚",
          suggestions: ["èˆŒè´¨çº¢ï¼Œè‹”é»„è…»", "èˆŒæ·¡æœ‰é½¿ç—•ï¼Œè‹”ç™½", "è„‰è·³å¾—å¾ˆå¿«", "æˆ‘ä¸çŸ¥é“æ€ä¹ˆçœ‹"],
          shouldEnd: false
        };
      }

      if (msg.indexOf("ä¸çŸ¥é“") !== -1 || msg.indexOf("æ€ä¹ˆçœ‹") !== -1) {
        return {
          reply: "æ²¡å…³ç³»ï¼Œæ‚¨å¯ä»¥å°è¯•æ‰¾ä¸€ä¸ªå…‰çº¿å……è¶³çš„åœ°æ–¹ï¼Œå¯¹ç€é•œå­è§‚å¯Ÿï¼š\n1. èˆŒå¤´æ˜¯ä»€ä¹ˆé¢œè‰²çš„ï¼Ÿï¼ˆæ·¡çº¢ã€çº¢ã€ç´«æš—ï¼‰\n2. èˆŒå¤´ä¸Šé¢é‚£å±‚è‹”åšå—ï¼Ÿæ˜¯ä»€ä¹ˆé¢œè‰²çš„ï¼Ÿï¼ˆç™½è‰²ã€é»„è‰²ã€è¿˜æ˜¯å‡ ä¹æ²¡æœ‰ï¼‰\n3. èˆŒå¤´è¾¹ç¼˜æœ‰æ²¡æœ‰ç‰™é½¿å‹å‡ºæ¥çš„å°å­ï¼ˆé½¿ç—•ï¼‰ï¼Ÿ\n\næ‚¨å¯ä»¥æŒ‰ç…§è¿™äº›æè¿°å‘Šè¯‰æˆ‘ã€‚",
          suggestions: ["èˆŒçº¢ï¼Œè‹”é»„åš", "èˆŒæ·¡çº¢ï¼Œæœ‰é½¿ç—•", "èˆŒçº¢ï¼Œæ²¡æœ‰è‹”"],
          shouldEnd: false
        };
      }

      reply = this.analyzeTongueAndPulse(msg, "å…¶ä»–ç—‡çŠ¶", hasPulse ? msg : "");
      return {
        reply,
        suggestions: ["æˆ‘æƒ³å’¨è¯¢è°ƒç†æ–¹æ¡ˆ", "å»æ™ºèƒ½é—®è¯Š", "é‡æ–°æè¿°"],
        shouldEnd: false // å…è®¸ç»§ç»­è¿½é—®
      };
    } else if (msg.indexOf("æ„Ÿå†’") !== -1 || msg.indexOf("ä¸èˆ’æœ") !== -1 || msg.indexOf("å¤´ç—›") !== -1) {
      reply = "äº†è§£æ‚¨çš„åˆæ­¥æƒ…å†µã€‚ä¸ºäº†æ›´å‡†ç¡®åœ°è¾¨è¯ï¼Œè¯·é—®æ‚¨ç°åœ¨æ˜¯å¦æœ‰å‘çƒ­æˆ–æ€•å†·çš„ç—‡çŠ¶ï¼Ÿ";
      suggestions = ["å‘çƒ­æ˜æ˜¾", "æ€•å†·æ¯”è¾ƒé‡", "å‘çƒ­æ€•å†·éƒ½æœ‰", "éƒ½æ²¡æœ‰"];
    } else if (msg.indexOf("æ€•å†·") !== -1 || msg.indexOf("å‘çƒ­") !== -1 || msg.indexOf("å¯’") !== -1) {
      reply = "æ”¶åˆ°ã€‚é‚£å‡ºæ±—çš„æƒ…å†µå¦‚ä½•ï¼Ÿæ˜¯åŠ¨åˆ™æ±—å‡ºï¼Œè¿˜æ˜¯æ™šä¸Šç¡è§‰æ—¶å‡ºæ±—ï¼ˆç›—æ±—ï¼‰ï¼Œæˆ–è€…æ— æ±—ï¼Ÿ";
      suggestions = ["åŠ¨åˆ™æ±—å‡º", "ç¡è§‰å‡ºæ±—", "æ— æ±—", "å‡ºæ±—æ­£å¸¸"];
    } else if (msg.indexOf("æ±—") !== -1) {
      reply = "æ˜ç™½äº†ã€‚æ‚¨çš„èƒƒå£ã€å£æ¸´æƒ…å†µä»¥åŠç¡çœ è´¨é‡å¦‚ä½•ï¼Ÿ";
      suggestions = ["èƒƒå£å·®/å£ä¸æ¸´", "å£æ¸´æƒ³å–æ°´", "ç¡çœ ä¸å¥½", "éƒ½è¿˜å¯ä»¥"];
    } else if (msg.indexOf("èƒƒå£") !== -1 || msg.indexOf("å£æ¸´") !== -1 || msg.indexOf("ç¡çœ ") !== -1 || msg.indexOf("ç¡") !== -1) {
      reply = "äº†è§£ã€‚æœ€åè¯·é—®ä¸‹æ‚¨çš„äºŒä¾¿ï¼ˆå¤§å°ä¾¿ï¼‰æƒ…å†µæ˜¯å¦æ­£å¸¸ï¼Ÿ";
      suggestions = ["å¤§ä¾¿å¹²ç»“", "å¤§ä¾¿ç¨€æº", "å°ä¾¿é»„èµ¤", "åŸºæœ¬æ­£å¸¸"];
    } else {
      reply = "æ„Ÿè°¢æ‚¨çš„è¯¦ç»†æè¿°ã€‚æ ¹æ®æ‚¨çš„åé¦ˆï¼Œåˆæ­¥åˆ¤æ–­å¯èƒ½å­˜åœ¨æ°”æœºå¤±è°ƒæˆ–å¤–æ„Ÿå› ç´ ã€‚å»ºè®®æ‚¨ä½¿ç”¨é¦–é¡µçš„â€œæ™ºèƒ½é—®è¯Šâ€åŠŸèƒ½ï¼Œå¡«å†™è¯¦ç»†çš„ç»“æ„åŒ–è¡¨å•ï¼Œä»¥ä¾¿æˆ‘ä¸ºæ‚¨ç”Ÿæˆæ›´ä¸“ä¸šçš„è¾¨è¯æŠ¥å‘Šå’Œè°ƒç†æ–¹æ¡ˆã€‚";
      suggestions = ["å»æ™ºèƒ½é—®è¯Š", "å†å’¨è¯¢å…¶ä»–é—®é¢˜"];
      shouldEnd = true;
    }

    return {
      reply,
      suggestions,
      shouldEnd
    };
  }

  // ä¸“é—¨çš„ä½“è´¨è¾¨è¯†é€»è¾‘ï¼ˆå‡çº§ç‰ˆï¼Œé€‚é…æ€»æ§çº§ Prompt ä½“ç³»ï¼‰
  /**
   * åŸºäº60é¢˜é—®å·çš„ä½“è´¨åˆ¤å®šæ ¸å¿ƒé€»è¾‘
   * @param {Object} quizAnswers - é¢˜ç›®IDå¯¹åº”åˆ†å€¼çš„å¯¹è±¡ { q1: 3, q2: 5, ... }
   */
  async analyzeConstitutionByQuiz(quizAnswers) {
    try {
      const result = analyzeConstitution(quizAnswers);
      
      // è®°å½•æµ‹è¯•ç»“æœåˆ° MongoDB
      if (result.main_constitutions && result.main_constitutions.length > 0) {
        for (const c of result.main_constitutions) {
          try {
            await ConstitutionRecord.create({
              constitution: c.name,
              timestamp: Date.now()
            });
          } catch (err) {
            console.error('Failed to save constitution record:', err);
          }
        }
      }
      
      return {
        code: 200,
        data: result
      };
    } catch (error) {
      console.error('Constitution analysis error:', error);
      throw error;
    }
  }

  async analyzeConstitution(data) {
    const { cold, energy, sweat, emotion, stool, phlegm, mouth, skin, tongue, pulse } = data;
    
    // è·å–å½“å‰èŠ‚æ°”
    const nearestTerm = await this.getNearestSolarTerm();
    
    let scores = {
      qi_deficiency: 0,
      yang_deficiency: 0,
      yin_deficiency: 0,
      damp_phlegm: 0,
      damp_heat: 0,
      blood_stasis: 0,
      qi_stagnation: 0,
      special_diathesis: 0,
      neutral: 5 // é»˜è®¤åˆ†å€¼ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–åå‘åˆ™ä¸ºå¹³å’Œ
    };

    let evidence = [];
    let lifestyleFactors = [];

    // 0. èˆŒè±¡è„‰è±¡å½±å“ï¼ˆæ–°å¢ï¼‰
    if (tongue) {
      if (tongue.indexOf('çº¢') !== -1 && tongue.indexOf('é»„') !== -1) {
        scores.damp_heat += 2;
        evidence.push('èˆŒçº¢è‹”é»„');
      }
      if (tongue.indexOf('æ·¡') !== -1 && tongue.indexOf('é½¿ç—•') !== -1) {
        scores.qi_deficiency += 2;
        evidence.push('èˆŒæ·¡æœ‰é½¿ç—•');
      }
    }
    if (pulse) {
      if (pulse.indexOf('å¼¦') !== -1) {
        scores.qi_stagnation += 2;
        evidence.push('è„‰å¼¦');
      }
    }

    // 1. å¯’çƒ­æ„Ÿå—
    if (cold === 'cold') {
      scores.yang_deficiency += 3;
      scores.neutral -= 2;
      evidence.push('æ˜æ˜¾æ€•å†·ã€æ‰‹è¶³ä¸æ¸©');
    } else if (cold === 'heat') {
      scores.yin_deficiency += 3;
      scores.neutral -= 2;
      evidence.push('æ˜“ä¸Šç«ã€å£å¹²å’½ç‡¥');
    }

    // 2. ç²¾ç¥ä¸ä½“åŠ›
    if (energy === 'low') {
      scores.qi_deficiency += 3;
      scores.yang_deficiency += 1;
      scores.neutral -= 2;
      evidence.push('æ˜“ç–²åŠ³ã€ç¥ç–²ä¹åŠ›');
    }

    // 3. å‡ºæ±—æƒ…å†µ
    if (sweat === 'much') {
      scores.qi_deficiency += 2;
      scores.yin_deficiency += 1;
      evidence.push('åŠ¨åˆ™æ±—å‡ºæ˜æ˜¾');
    }

    // 4. æƒ…ç»ªæ³¢åŠ¨
    if (emotion === 'depressed' || emotion === 'anxious') {
      scores.qi_stagnation += 3;
      scores.neutral -= 1;
      evidence.push('æƒ…ç»ªæ³¢åŠ¨æ˜æ˜¾ã€æ˜“ç„¦è™‘éƒé—·');
    }

    // 5. æ¶ˆåŒ–ä¸ä»£è°¢ (æ‰©å±•é€»è¾‘)
    if (stool === 'loose') {
      scores.yang_deficiency += 2;
      scores.damp_phlegm += 1;
      evidence.push('å¤§ä¾¿æºè–„');
    } else if (stool === 'dry') {
      scores.yin_deficiency += 2;
      evidence.push('å¤§ä¾¿å¹²ç»“');
    }

    // 6. ç—°æ¹¿ç‰¹å¾
    if (phlegm === 'much' || mouth === 'greasy') {
      scores.damp_phlegm += 3;
      scores.neutral -= 2;
      evidence.push('èº«ä½“æ²‰é‡ã€å£è…»ç—°å¤š');
    }

    // 7. æ¹¿çƒ­ç‰¹å¾
    if (mouth === 'bitter' || (phlegm === 'yellow' && mouth === 'greasy')) {
      scores.damp_heat += 3;
      scores.neutral -= 2;
      evidence.push('å£è‹¦ã€åˆ†æ³Œç‰©é»ç¨ ');
    }

    // 8. è¡€ç˜€ç‰¹å¾
    if (skin === 'dark' || skin === 'stain') {
      scores.blood_stasis += 3;
      evidence.push('è‚¤è‰²æ™¦æš—ã€å¯èƒ½æœ‰å›ºå®šéƒ¨ä½ä¸é€‚');
    }

    // è®¡ç®—ä¸»æ¬¡ä½“è´¨
    const sortedConstitutions = Object.entries(scores)
      .filter(([key]) => key !== 'neutral')
      .sort((a, b) => b[1] - a[1]);

    let primaryKey = 'neutral';
    let secondaryKey = null;

    if (sortedConstitutions[0][1] >= 3) {
      primaryKey = sortedConstitutions[0][0];
      if (sortedConstitutions[1][1] >= 2) {
        secondaryKey = sortedConstitutions[1][0];
      }
    }

    const constitutionNames = {
      qi_deficiency: 'æ°”è™šä½“è´¨',
      yang_deficiency: 'é˜³è™šä½“è´¨',
      yin_deficiency: 'é˜´è™šä½“è´¨',
      damp_phlegm: 'ç—°æ¹¿ä½“è´¨',
      damp_heat: 'æ¹¿çƒ­ä½“è´¨',
      blood_stasis: 'è¡€ç˜€ä½“è´¨',
      qi_stagnation: 'æ°”éƒä½“è´¨',
      special_diathesis: 'ç‰¹ç¦€ä½“è´¨',
      neutral: 'å¹³å’Œä½“è´¨'
    };

    let adjustment = '';
    if (primaryKey === 'neutral') {
      adjustment = `ä¿æŒç°çŠ¶ï¼Œé¡ºåº”${nearestTerm.name}èŠ‚æ°”ï¼Œ${nearestTerm.living}ã€‚`;
    } else {
      const primaryName = constitutionNames[primaryKey];
      const secondaryName = secondaryKey ? constitutionNames[secondaryKey] : '';
      adjustment = `é’ˆå¯¹${primaryName}${secondaryName ? 'å…¼' + secondaryName : ''}å€¾å‘ï¼Œå»ºè®®ï¼š${nearestTerm.diet} åŒæ—¶æ³¨æ„${nearestTerm.living}ã€‚`;
    }

    // æ„é€ ç¬¦åˆè§„èŒƒçš„è¾“å‡ºç»“æ„
    const result = {
      primary_constitution: constitutionNames[primaryKey] + (primaryKey === 'neutral' ? '' : 'å€¾å‘'),
      secondary_constitution: secondaryKey ? constitutionNames[secondaryKey] + 'å€¾å‘' : '',
      evidence_summary: evidence.length > 0 ? `ä¸»è¦è¡¨ç°ä¸º${evidence.join('ï¼Œ')}ã€‚` : 'æ•´ä½“çŠ¶æ€è¾ƒä¸ºå¹³è¡¡ã€‚',
      lifestyle_factors: lifestyleFactors.length > 0 ? lifestyleFactors.join('ï¼›') : 'ä½œæ¯åŸºæœ¬è§„å¾‹ï¼Œè¿‘æœŸç¯å¢ƒæ°”å€™å—' + nearestTerm.name + 'å½±å“ã€‚',
      adjustment_direction: adjustment,
      disclaimer: 'æœ¬è¯„ä¼°ä»…ç”¨äºä¸­åŒ»ä½“è´¨å€¾å‘å‚è€ƒï¼Œä¸ä½œä¸ºåŒ»ç–—è¯Šæ–­å»ºè®®ã€‚å»ºè®®åœ¨ä¸“ä¸šåŒ»å¸ˆæŒ‡å¯¼ä¸‹è¿›è¡Œè°ƒç†ã€‚'
    };

    // è®°å½•ä½“è´¨æµ‹è¯•ç»“æœåˆ° MongoDB
    try {
      await ConstitutionRecord.create({
        constitution: constitutionNames[primaryKey], // è®°å½•åŸå§‹åç§°ï¼Œä¸å¸¦â€œå€¾å‘â€
        timestamp: Date.now()
      });
    } catch (err) {
      console.error('Failed to save constitution record:', err);
    }

    return result;
  }

  getDefaultResult() {
    return {
      syndrome: 'è¯å‹ä¸æ˜ç¡®',
      syndromeDesc: 'æ ¹æ®ç›®å‰æä¾›çš„ç—‡çŠ¶ï¼Œå°šæ— æ³•æ˜ç¡®è¾¨æè¯å‹',
      treatment: 'å»ºè®®ä¿æŒè§‚å¯Ÿï¼Œè‹¥ç—‡çŠ¶æŒç»­è¯·åŠæ—¶å’¨è¯¢ä¸“ä¸šåŒ»å¸ˆ',
      prescriptions: [],
      lifestyle: ['ä¿æŒè§„å¾‹ä½œæ¯', 'é¥®é£Ÿå‡è¡¡', 'å¿ƒæƒ…èˆ’ç•…'],
      disclaimer: 'æœ¬è¯„ä¼°ç»“æœä»…ä¾›å¥åº·ç§‘æ™®å‚è€ƒï¼Œä¸ä½œä¸ºåŒ»ç–—è¯Šæ–­ä¾æ®ã€‚'
    };
  }

  // ä¸º Admin æä¾›çš„æ–¹æ³•
  async getAllSyndromes(params = {}) {
    const { keyword = '', current = 1, pageSize = 10 } = params;
    let query = {};
    if (keyword) {
      query = {
        $or: [
          { name: { $regex: keyword, $options: 'i' } },
          { description: { $regex: keyword, $options: 'i' } }
        ]
      };
    }
    
    const total = await Syndrome.countDocuments(query);
    const list = await Syndrome.find(query)
      .skip((current - 1) * pageSize)
      .limit(pageSize);

    return {
      list,
      total
    };
  }

  async saveSyndrome(data) {
    if (data._id || data.id) {
      const id = data._id || data.id;
      await Syndrome.findByIdAndUpdate(id, data, { upsert: true });
    } else {
      await Syndrome.create(data);
    }
    return true;
  }

  async deleteSyndromes(ids) {
    await Syndrome.deleteMany({ _id: { $in: ids } });
    return true;
  }

  // è·å–æ¯æ—¥é‡‘å¥
  async getDailyGoldSentence() {
    const sentences = this.aiConfig.goldSentences;
    const index = new Date().getDate() % sentences.length;
    return sentences[index];
  }

  // è·å–å¤œé—´å…³æ€€
  async getNightReminder() {
    const hour = new Date().getHours();
    if (hour >= 22 || hour < 5) {
      const reminders = this.aiConfig.nightReminders;
      const index = Math.floor(Math.random() * reminders.length);
      return reminders[index];
    }
    return null;
  }

  // è·å–å½“å‰æœ€è¿‘çš„èŠ‚æ°”å»ºè®®
  async getNearestSolarTerm() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // 1-12
    const currentDay = now.getDate();
    
    // è®¡ç®—å½“å‰æ—¥æœŸåˆ°æ¯ä¸ªèŠ‚æ°”çš„è·ç¦»ï¼ˆä»¥å¤©ä¸ºå•ä½ï¼Œè¿‘ä¼¼è®¡ç®—ï¼‰
    let minDiff = Infinity;
    let nearestTerm = null;

    this.solarTerms.forEach(term => {
      // æ„é€ å½“å‰å¹´ä»½çš„èŠ‚æ°”æ—¥æœŸ
      const termDate = new Date(now.getFullYear(), term.month - 1, term.day);
      let diff = Math.abs(now.getTime() - termDate.getTime());
      
      // ä¹Ÿè¦è€ƒè™‘è·¨å¹´çš„æƒ…å†µï¼ˆæ¯”å¦‚å½“å‰æ˜¯12æœˆåº•ï¼Œæœ€è¿‘çš„å¯èƒ½æ˜¯æ˜å¹´çš„å°å¯’ï¼‰
      const nextYearTermDate = new Date(now.getFullYear() + 1, term.month - 1, term.day);
      const prevYearTermDate = new Date(now.getFullYear() - 1, term.month - 1, term.day);
      
      diff = Math.min(diff, Math.abs(now.getTime() - nextYearTermDate.getTime()));
      diff = Math.min(diff, Math.abs(now.getTime() - prevYearTermDate.getTime()));

      if (diff < minDiff) {
        minDiff = diff;
        nearestTerm = term;
      }
    });

    return nearestTerm;
  }

  // è·å–æ‚£è€…ç»Ÿè®¡æ•°æ®
  async getPatientStats(timeRange = 'all') {
    const now = new Date();
    let query = {};
    
    if (timeRange === 'today') {
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      query.timestamp = { $gte: startOfDay };
    } else if (timeRange === 'week') {
      const day = now.getDay() || 7;
      const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (day - 1)).getTime();
      query.timestamp = { $gte: startOfWeek };
    } else if (timeRange === 'month') {
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
      query.timestamp = { $gte: startOfMonth };
    }
    
    let filteredRecords = await DiagnosisRecord.find(query);

    // å¤„ç†å­£èŠ‚è¿‡æ»¤ (MongoDB ä¸æ–¹ä¾¿ç›´æ¥å¤„ç†æœˆä»½ï¼Œæ‰€ä»¥åœ¨å†…å­˜ä¸­è¿‡æ»¤)
    if (['spring', 'summer', 'autumn', 'winter'].includes(timeRange)) {
      filteredRecords = filteredRecords.filter(r => {
        const month = new Date(r.timestamp).getMonth(); // 0-11
        if (timeRange === 'spring') return [2, 3, 4].includes(month);
        if (timeRange === 'summer') return [5, 6, 7].includes(month);
        if (timeRange === 'autumn') return [8, 9, 10].includes(month);
        if (timeRange === 'winter') return [11, 0, 1].includes(month);
        return true;
      });
    }

    const stats = {};
    filteredRecords.forEach(r => {
      stats[r.syndrome] = (stats[r.syndrome] || 0) + 1;
    });

    const totalRecords = filteredRecords.length;
    return Object.keys(stats).map(name => ({
      name,
      value: stats[name],
      count: stats[name],
      rate: totalRecords > 0 ? ((stats[name] / totalRecords) * 100).toFixed(2) + '%' : '0%'
    })).sort((a, b) => b.count - a.count);
  }

  // è·å–ä½“è´¨ç»Ÿè®¡æ•°æ®
  async getConstitutionStats(timeRange = 'all') {
    const now = new Date();
    let query = {};
    
    if (timeRange === 'today') {
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      query.timestamp = { $gte: startOfDay };
    } else if (timeRange === 'week') {
      const day = now.getDay() || 7;
      const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (day - 1)).getTime();
      query.timestamp = { $gte: startOfWeek };
    } else if (timeRange === 'month') {
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
      query.timestamp = { $gte: startOfMonth };
    }
    
    let filteredRecords = await ConstitutionRecord.find(query);

    if (['spring', 'summer', 'autumn', 'winter'].includes(timeRange)) {
      filteredRecords = filteredRecords.filter(r => {
        const month = new Date(r.timestamp).getMonth(); // 0-11
        if (timeRange === 'spring') return [2, 3, 4].includes(month);
        if (timeRange === 'summer') return [5, 6, 7].includes(month);
        if (timeRange === 'autumn') return [8, 9, 10].includes(month);
        if (timeRange === 'winter') return [11, 0, 1].includes(month);
        return true;
      });
    }

    const stats = {};
    filteredRecords.forEach(r => {
      stats[r.constitution] = (stats[r.constitution] || 0) + 1;
    });

    const totalRecords = filteredRecords.length;
    return Object.keys(stats).map(name => ({
      name,
      value: stats[name],
      count: stats[name],
      rate: totalRecords > 0 ? ((stats[name] / totalRecords) * 100).toFixed(2) + '%' : '0%'
    })).sort((a, b) => b.count - a.count);
  }

  // åˆ†ææ¯æ—¥ä½“è´¨å€¾å‘
  async analyzeDailyStatus(status) {
    // å…¼å®¹å­—ç¬¦ä¸²å½¢å¼çš„å¸ƒå°”å€¼
    const fatigue = status.fatigue === true || status.fatigue === 'true';
    const cold = status.cold === true || status.cold === 'true';
    const sleep = status.sleep;

    let result = {
      tendency: 'å¹³è¡¡',
      summary: '',
      advice: ''
    };

    if (fatigue && cold && sleep === 'poor') {
      result.tendency = 'å¤±è°ƒ';
      result.summary = 'ä»Šæ—¥èº«ä½“å‘å‡ºç–²åŠ³ä¿¡å·ï¼Œä¼´æœ‰ç•å¯’ä¸ç¡çœ ä¸ä½³ï¼Œæ°”æ¯è¿è¡Œç•¥æ˜¾è¿Ÿæ»ã€‚';
      result.advice = 'å»ºè®®æ¨æ‰ä¸å¿…è¦çš„åº”é…¬ï¼Œå°½æ—©ä¼‘æ¯ï¼Œé¥®é£Ÿå®œé€‰æ¸©è½¯æ˜“æ¶ˆåŒ–çš„é£Ÿç‰©ã€‚';
    } else if (cold) {
      result.tendency = 'åå¯’';
      result.summary = 'ä»Šæ—¥ä½“å†…é˜³æ°”å¾…æŒ¯ï¼Œä½“æ„Ÿåäºå¯’å‡‰ï¼Œèƒ½é‡ç•¥æ˜¾ä¸è¶³ã€‚';
      result.advice = 'å»ºè®®é¥®ç”¨æ¸©çƒ­çš„æ°´æˆ–ç”Ÿå§œçº¢æ£èŒ¶ï¼Œå¹¶åŠ å¼ºè¶³éƒ¨ä¿æš–ï¼Œé¿å…å—å‡‰ã€‚';
    } else if (fatigue) {
      result.tendency = 'åè™š';
      result.summary = 'èº«ä½“æ°”åŠ›ç¨æ˜¾ä¸æ”¯ï¼Œå¤„äºè½»åº¦é€æ”¯çŠ¶æ€ï¼Œéœ€è¦åŠæ—¶è¡¥å……èƒ½é‡ã€‚';
      result.advice = 'å»ºè®®å‡å°‘é«˜å¼ºåº¦ä½“åŠ›åŠ³åŠ¨ï¼Œé€‚é‡é£Ÿç”¨å±±è¯ã€å¤§æ£ç­‰ç›Šæ°”é£Ÿæï¼Œä¿è¯åˆä¼‘ã€‚';
    } else if (sleep === 'poor') {
      result.tendency = 'åçƒ­';
      result.summary = 'å¿ƒç¥ç¨æ˜¾ä¸å®ï¼Œä½“å†…ç¯å¢ƒç•¥æ˜¾ç‡¥åŠ¨ï¼Œå‘ˆç°è½»å¾®çš„é˜³äº¢çŠ¶æ€ã€‚';
      result.advice = 'å»ºè®®æ™šé¤ä¿æŒæ¸…æ·¡ï¼Œç¡å‰é™å¿ƒå†¥æƒ³æˆ–çƒ­æ°´æ³¡è„šï¼Œé¿å…å‰§çƒˆè¿åŠ¨ã€‚';
    } else {
      result.tendency = 'å¹³è¡¡';
      result.summary = 'ä»Šæ—¥æ°”æ¯è°ƒåŒ€ï¼Œç¥æ¸…æ°”çˆ½ï¼Œèº«ä½“å¤„äºè¾ƒä¸ºç†æƒ³çš„åŠ¨æ€å¹³è¡¡ä¸­ã€‚';
      result.advice = 'è¯·ç»§ç»­ä¿æŒè§„å¾‹çš„ä½œæ¯ä¸å¹³å’Œçš„å¿ƒæ€ï¼Œé€‚åº¦è¿›è¡Œæˆ·å¤–æ´»åŠ¨ã€‚';
    }

    return result;
  }

  // æ–°å¢ï¼šè·å–è¯¦ç»†è¯Šæ–­è®°å½•åˆ—è¡¨
  async getDiagnosisRecords(params = {}) {
    const { current = 1, pageSize = 10 } = params;
    const total = await DiagnosisRecord.countDocuments();
    const list = await DiagnosisRecord.find()
      .sort({ timestamp: -1 })
      .skip((current - 1) * pageSize)
      .limit(pageSize);
      
    return {
      list,
      total
    };
  }
}

export default new TcmService();